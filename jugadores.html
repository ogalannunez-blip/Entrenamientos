<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Partido de FÃºtbol</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:#f4f7f6;color:#333;margin:0;padding:10px}.container{max-width:800px;margin:auto;background-color:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.1)}h1,h2{text-align:center;color:#1a73e8}h1{font-size:1.8em;display:flex;align-items:center;justify-content:center;gap:15px}h2{border-bottom:2px solid #1a73e8;padding-bottom:10px;margin-top:30px}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{padding:12px;text-align:left;border-bottom:1px solid #ddd}th{background-color:#f2f2f2}input[type=number]{width:60px;padding:5px;border:1px solid #ccc;border-radius:4px;text-align:center}input[type=text]{padding:8px;border:1px solid #ccc;border-radius:4px;width:60%}.status-radio{display:flex;gap:10px;justify-content:flex-start}.resultado{padding:20px;margin-top:10px;border-radius:8px;text-align:center;color:#fff;transition:background-color .3s ease}.probabilidad{font-size:2.5em;font-weight:700;margin:0}.recomendacion{font-size:1.1em;font-weight:400;margin-top:10px}.resumen,.lista-apuntados{font-size:.9em;font-weight:400;margin-top:15px;opacity:.9;border-top:1px solid rgba(255,255,255,.3);padding-top:10px}.lista-apuntados{text-align:left;padding-left:15px;max-height:120px;overflow-y:auto}.verde{background-color:#28a745}.ambar{background:linear-gradient(45deg,#ffc107,#ff9800);color:#333}.rojo{background:linear-gradient(45deg,#dc3545,#b71c1c)}.admin-only{display:none}.admin-view .admin-only{display:table-cell}.admin-view .admin-button{display:block}#admin-lock, #player-login{cursor:pointer;font-size:1.5em}#login-info{font-size:0.8em;color:#333;text-align:center;margin-top:10px}#refuerzos-section{margin-top:25px;padding:15px;border:1px solid #eee;border-radius:8px;display:none}@media screen and (max-width:600px){body{padding:5px}.container{padding:15px}h1{font-size:1.5em}.probabilidad{font-size:2em}.recomendacion{font-size:1em}table,thead,tbody,th,td,tr{display:block}thead tr{position:absolute;top:-9999px;left:-9999px}tr{border:1px solid #ccc;margin-bottom:15px;border-radius:5px;padding:5px}td{border:none;border-bottom:1px solid #eee;position:relative;padding-left:50%;text-align:right}td:before{position:absolute;left:6px;width:45%;padding-right:10px;white-space:nowrap;text-align:left;font-weight:700}td:nth-of-type(1):before{content:"Nombre"}td:nth-of-type(2):before{content:"Estado"}td:nth-of-type(3):before{content:"Jugados"}td:nth-of-type(4):before{content:"Total"}td:nth-of-type(5):before{content:"Bajas"}td:nth-of-type(6):before{content:"Fiabilidad"}.status-radio{justify-content:flex-end}input[type=number]{width:70px}.admin-view .admin-only{display:block}}
    </style>
</head>
<body>

<div class="container">
    <h1><span id="admin-lock">ðŸ”“</span> Gestor de Partido <span id="player-login">ðŸ‘¤</span></h1>
    <div id="login-info">IdentifÃ­cate para responder</div>
    <h2 id="match-date-title"></h2>

    <div id="main-content">
        <button id="reset-button" class="reset-button admin-only admin-button" style="display:none">Resetear Asistencia</button>
        <div id="resultado"></div>
        
        <div id="refuerzos-section">
            <h4>AÃ±adir Refuerzos</h4>
            <input type="text" id="refuerzo-nombre" placeholder="Nombre del refuerzo...">
            <button id="add-refuerzo-btn">AÃ±adir</button>
        </div>
        
        <table id="tabla-jugadores">
            <thead><tr><th>Nombre</th><th>Estado</th><th class="admin-only">Jugados</th><th class="admin-only">Total</th><th class="admin-only">Bajas</th><th>Fiabilidad</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
// --- PEGA AQUÃ TUS CREDENCIALES DE FIREBASE ---
const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_AUTH_DOMAIN",
    databaseURL: "TU_DATABASE_URL",
    projectId: "TU_PROJECT_ID",
    storageBucket: "TU_STORAGE_BUCKET",
    messagingSenderId: "TU_MESSAGING_SENDER_ID",
    appId: "TU_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();
let adminPassword = "", isAdmin = false, loggedInPlayer = null, fullPlayerList = [];

// --- LÃ“GICA DE LOGIN ---
database.ref('config/password').once('value', (snapshot) => { adminPassword = snapshot.val(); });

document.getElementById('admin-lock').addEventListener('click', () => { /* ... (sin cambios) ... */ });
document.getElementById('player-login').addEventListener('click', () => { /* ... (sin cambios) ... */ });

document.addEventListener('DOMContentLoaded', function() {
    const mainContent = document.getElementById('main-content');
    
    database.ref().on('value', (snapshot) => {
        const dbData = snapshot.val();
        if (dbData && dbData.jugadores) {
            mainContent.style.display = 'block';
            fullPlayerList = dbData.jugadores;
            checkForAutoReset(dbData);
        }
    });

    async function checkForAutoReset(dbData) {
        const ahora = new Date();
        let nextMatchDate = dbData.matchInfo ? new Date(dbData.matchInfo.nextMatchDate) : getNextWednesday();
        const resetTime = new Date(nextMatchDate);
        resetTime.setHours(22, 0, 0, 0);

        if (ahora > resetTime) {
            const newMatchDate = getNextWednesday();
            const updates = {};
            dbData.jugadores.forEach((player, index) => {
                updates[`jugadores/${index}/status`] = 'pendiente';
            });
            updates['matchInfo/nextMatchDate'] = newMatchDate.toISOString();
            updates['refuerzos'] = null; // Borrar refuerzos de la semana anterior
            await database.ref().update(updates);
        } else {
            iniciarApp(dbData, nextMatchDate);
        }
    }

    // --- LÃ“GICA PARA AÃ‘ADIR Y GESTIONAR REFUERZOS ---
    document.getElementById('add-refuerzo-btn').addEventListener('click', () => {
        const nombreRefuerzo = document.getElementById('refuerzo-nombre').value.trim();
        if(nombreRefuerzo && loggedInPlayer) {
            const newRefuerzo = {
                nombre: nombreRefuerzo,
                anadidoPor: loggedInPlayer.nombre
            };
            database.ref('refuerzos').push(newRefuerzo);
            document.getElementById('refuerzo-nombre').value = '';
        } else if (!loggedInPlayer) {
            alert("Debes identificarte primero para aÃ±adir un refuerzo.");
        }
    });

    function iniciarApp(dbData, matchDate) {
        const jugadores = dbData.jugadores;
        const refuerzos = dbData.refuerzos || {};
        const options = { weekday: 'long', month: 'long', day: 'numeric' };
        const titleEl = document.getElementById('match-date-title');
        titleEl.textContent = `Partido del ${matchDate.toLocaleDateString('es-ES', options)}`;
        titleEl.dataset.date = matchDate.toISOString();
        
        // Mostrar secciÃ³n de refuerzos si hay alguien logueado
        document.getElementById('refuerzos-section').style.display = (isAdmin || loggedInPlayer) ? 'block' : 'none';

        inicializarTabla(jugadores);
        calcularNecesidad(jugadores, refuerzos, matchDate);
    }
    
    function inicializarTabla(jugadores) { /* ... (sin cambios) ... */ }

    function calcularNecesidad(jugadores, refuerzos, matchDate) {
        const JUGADORES_NECESARIOS = 10;
        let confirmados = 0, proyeccionPendientes = 0, pendientesCount = 0;
        const listaApuntados = [];
        const listaRefuerzos = [];

        Object.values(refuerzos).forEach(refuerzo => listaRefuerzos.push(refuerzo.nombre));
        const numRefuerzos = listaRefuerzos.length;

        jugadores.forEach(jugador => {
            if (jugador.status === 'si') {
                confirmados++;
                listaApuntados.push(jugador.nombre);
            } else if (jugador.status === 'pendiente') {
                pendientesCount++;
            }
        });
        
        const totalConfirmados = confirmados + numRefuerzos;

        // --- CORRECCIÃ“N MENSAJE "SOLICITAR REFUERZOS" ---
        if (pendientesCount === 0 && totalConfirmados < JUGADORES_NECESARIOS) {
            const resultadoDiv = document.getElementById('resultado');
            resultadoDiv.className = 'resultado rojo';
            resultadoDiv.innerHTML = `
                <p class="probabilidad">${((totalConfirmados / JUGADORES_NECESARIOS) * 100).toFixed(0)}%</p>
                <p class="recomendacion">No se llega a 10. Â¡Hay que buscar ${JUGADORES_NECESARIOS - totalConfirmados} refuerzo(s)!</p>
                <div class="resumen"><strong>Apuntados (${totalConfirmados}):</strong><div class="lista-apuntados">${[...listaApuntados, ...listaRefuerzos.map(r => r + " (R)")].join('<br>')}</div></div>
            `;
            return;
        }

        const ahora = new Date();
        const horasRestantes = (matchDate - ahora) / 36e5;
        let factorConfianza = 0.1;
        if (horasRestantes > 72) factorConfianza = 0.8;
        else if (horasRestantes > 48) factorConfianza = 0.6;
        else if (horasRestantes > 31) factorConfianza = 0.3;
        else factorConfianza = 0.15;

        jugadores.forEach(jugador => { /* ... (cÃ¡lculo de proyecciÃ³n sin cambios) ... */ });
        
        const proyeccionAjustada = totalConfirmados + (proyeccionPendientes * factorConfianza);
        let probabilidad = (proyeccionAjustada / JUGADORES_NECESARIOS) * 100;
        
        if (totalConfirmados < JUGADORES_NECESARIOS) probabilidad = Math.min(99, probabilidad);
        else probabilidad = 100;

        // ... (resto de la funciÃ³n para mostrar resultados, adaptada para el total de confirmados)
        const resultadoDiv = document.getElementById('resultado');
        let recomendacion = "", claseColor = "", alertaBajas = "";
        const esMartesTarde = ahora.getDay() === 2 && ahora.getHours() >= 14;
        const faltan = JUGADORES_NECESARIOS - totalConfirmados;

        if (esMartesTarde && totalConfirmados < 10) { /* ... (sin cambios) ... */ }
        
        if (!recomendacion) { /* ... (sin cambios) ... */ }

        if (totalConfirmados >= 10) {
            claseColor = "verde";
            recomendacion = `Â¡PARTIDO CONFIRMADO! Ya sois ${totalConfirmados}.`;
        }

        const listaHtml = [...listaApuntados, ...listaRefuerzos.map(r => r + " (R)")];
        const listaHtmlContent = listaHtml.length > 0 ? `<strong>Apuntados (${totalConfirmados}):</strong><div class="lista-apuntados">${listaHtml.join('<br>')}</div>` : '<strong>Nadie apuntado todavÃ­a.</strong>';

        resultadoDiv.className = 'resultado ' + claseColor;
        resultadoDiv.innerHTML = `<p class="probabilidad">${probabilidad.toFixed(0)}%</p><p style="margin: -10px 0 10px 0; opacity: 0.8;">de probabilidad de llegar a 10</p><p class="recomendacion">${recomendacion}${alertaBajas}</p><div class="resumen">${listaHtmlContent}</div>`;
    }

    function getNextWednesday() { /* ... (sin cambios) ... */ }
    
    // El resto de funciones (login, etc) estÃ¡n acortadas por brevedad, pero deben ser las mismas que la versiÃ³n anterior.
    // AsegÃºrate de que las funciones de login y admin estÃ¡n completas en tu archivo.
});
</script>
<script>
// Pega aquÃ­ de nuevo las funciones de login completas si las has borrado sin querer
document.getElementById('admin-lock').addEventListener('click', () => {
    if (isAdmin) {
        isAdmin = false; loggedInPlayer = null;
        document.body.classList.remove('admin-view');
        document.getElementById('admin-lock').textContent = 'ðŸ”“';
        document.getElementById('login-info').textContent = 'IdentifÃ­cate para responder
