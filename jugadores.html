<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Partido de F√∫tbol</title>
    <style>
        /* Estilos generales del cuerpo y contenedor principal */
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:#f4f7f6;color:#333;margin:0;padding:10px}
        .container{max-width:800px;margin:auto;background-color:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
        
        /* Estilos para t√≠tulos y encabezados */
        h1,h2{text-align:center;color:#1a73e8}
        h1{font-size:1.8em;display:flex;align-items:center;justify-content:center;gap:15px}
        h2{border-bottom:2px solid #1a73e8;padding-bottom:10px;margin-top:30px}
        
        /* Estilos para la tabla de jugadores */
        table{width:100%;border-collapse:collapse;margin-top:20px}
        th,td{padding:12px;text-align:left;border-bottom:1px solid #ddd}
        th{background-color:#f2f2f2}
        
        /* Estilos para campos de entrada */
        input[type=number]{width:60px;padding:5px;border:1px solid #ccc;border-radius:4px;text-align:center}
        input[type=text]{padding:8px;border:1px solid #ccc;border-radius:4px;width:60%}
        
        /* Estilos para los botones de estado (S√≠/No/Pendiente) */
        .status-radio{display:flex;gap:10px;justify-content:flex-start}
        
        /* Estilos del cuadro de resumen de probabilidad */
        .resultado{padding:20px;margin-top:10px;border-radius:8px;text-align:center;color:#fff;transition:background-color .3s ease}
        .probabilidad{font-size:2.5em;font-weight:700;margin:0}
        .recomendacion{font-size:1.1em;font-weight:400;margin-top:10px}
        .resumen,.lista-apuntados{font-size:.9em;font-weight:400;margin-top:15px;opacity:.9;border-top:1px solid rgba(255,255,255,.3);padding-top:10px}
        .lista-apuntados{text-align:left;list-style:none;padding-left:0;}
        .lista-apuntados li{display:flex;align-items:center;padding:3px 0;}
        
        /* Icono para borrar refuerzos y jugadores */
        .delete-refuerzo, .delete-player-btn{cursor:pointer;font-size:1.1em;opacity:0.7;}
        .delete-refuerzo{margin-left:auto;}
        .delete-refuerzo:hover, .delete-player-btn:hover{opacity:1;}
        .delete-player-btn {background:none; border:none; padding:0 5px; font-size:1.2em;}
        
        /* Colores del cuadro de resumen */
        .verde{background-color:#28a745}
        .ambar{background:linear-gradient(45deg,#ffc107,#ff9800);color:#333}
        .rojo{background:linear-gradient(45deg,#dc3545,#b71c1c)}
        
        /* Clases para controlar la visibilidad del admin */
        .admin-only{display:none}
        .admin-view .admin-only{display:table-cell !important;}
        .admin-view .admin-button{display:block !important;}
        .admin-view #add-player-section{display:block !important;}

        /* Iconos de login y candado */
        #admin-lock, #player-login{cursor:pointer;font-size:1.5em}
        #login-info{font-size:0.8em;color:#333;text-align:center;margin-top:10px}
        
        /* Secciones de refuerzos y a√±adir jugador */
        #refuerzos-section, #add-player-section{margin-top:25px;padding:15px;border:1px solid #eee;border-radius:8px;display:none}
        
        /* --- ESTILOS PARA ICONOS DE ESTADO --- */
        .status-icon{display:inline-flex;justify-content:center;align-items:center;width:1.4em;height:1.4em;border-radius:50%;color:#fff;font-weight:700;margin-right:8px;border:1px solid rgba(0,0,0,.1);font-size:.9em; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);}
        .icon-si{background-color:#28a745}
        .icon-pendiente{background-color:#ffc107;color:#333}
        .icon-no{background-color:#dc3545}
        
        /* Modo Test */
        #admin-test-section button{padding:5px 10px;margin-left:5px;}

        /* --- ESTILOS PARA M√ìVILES --- */
        @media screen and (max-width:600px){
            body{padding:5px}.container{padding:15px}h1{font-size:1.5em}.probabilidad{font-size:2em}.recomendacion{font-size:1em}
            table,thead,tbody,th,td,tr{display:block}
            thead tr{position:absolute;top:-9999px;left:-9999px}
            tr{border:1px solid #ccc;margin-bottom:15px;border-radius:5px;padding:5px}
            td{border:none;border-bottom:1px solid #eee;position:relative;padding-left:50%;text-align:right}
            td:before{position:absolute;left:6px;width:45%;padding-right:10px;white-space:nowrap;text-align:left;font-weight:700}
            td:nth-of-type(1):before{content:"Nombre"}td:nth-of-type(2):before{content:"Estado"}td:nth-of-type(3):before{content:"Jugados"}td:nth-of-type(4):before{content:"Total"}td:nth-of-type(5):before{content:"Bajas"}td:nth-of-type(6):before{content:"Fiabilidad"}td:nth-of-type(7):before{content:"Acci√≥n"}
            .status-radio{justify-content:flex-end}input[type=number]{width:70px}
            .admin-view .admin-only{display:block !important;}
        }
    </style>
</head>
<body>

<div class="container">
    <h1><span id="admin-lock">üîì</span> Gestor de Partido <span id="player-login">üë§</span></h1>
    <div id="login-info">Identif√≠cate para responder</div>
    <h2 id="match-date-title">Cargando...</h2>

    <div id="main-content" style="display: none;">
        <button id="reset-button" class="reset-button admin-only admin-button" style="display:none">Resetear Asistencia</button>
        
        <div id="resultado"></div>
        
        <div id="refuerzos-section">
            <h4>A√±adir Refuerzos</h4>
            <input type="text" id="refuerzo-nombre" placeholder="Nombre del refuerzo...">
            <button id="add-refuerzo-btn">A√±adir</button>
        </div>
        
        <table id="tabla-jugadores">
            <thead><tr><th>Nombre</th><th>Estado</th><th class="admin-only">Jugados</th><th class="admin-only">Total</th><th class="admin-only">Bajas</th><th>Fiabilidad</th><th class="admin-only">Acci√≥n</th></tr></thead>
            <tbody></tbody>
        </table>

        <div id="add-player-section" class="admin-only">
            <h4>A√±adir Nuevo Jugador a la Plantilla</h4>
            <input type="text" id="new-player-name" placeholder="Nombre del nuevo jugador...">
            <button id="add-player-btn">A√±adir</button>
        </div>

        <div id="admin-test-section" style="display: none; margin-top: 20px; padding: 15px; border: 2px dashed #ccc; border-radius: 8px;">
            <h4 style="margin-top:0;">Modo Test</h4>
            <label for="test-date">Simular Fecha y Hora:</label>
            <input type="datetime-local" id="test-date">
            <button id="apply-test-date">Aplicar</button>
            <button id="reset-test-date">Hora Real</button>
            <p id="current-time-display" style="font-size: 0.9em; color: #555; margin-top: 10px;"></p>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
// --- CONFIGURACI√ìN E INICIALIZACI√ìN DE FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyAeUfYINReyta5uNZd8sDCylju0nE7oy-A",
  authDomain: "entrenamientos-5f314.firebaseapp.com",
  databaseURL: "https://entrenamientos-5f314-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "entrenamientos-5f314",
  storageBucket: "entrenamientos-5f314.firebasestorage.app",
  messagingSenderId: "322454738753",
  appId: "G-SGS7EYBFTZ"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// --- VARIABLES GLOBALES DE ESTADO ---
let adminPassword = "";
let isAdmin = false;
let loggedInPlayer = null;
let currentDbData = null;
let simulatedTime = null; // Para el modo test

// --- L√ìGICA DE LOGIN ---

// Obtiene la contrase√±a de admin una sola vez al cargar
database.ref('config/password').once('value', (snapshot) => { adminPassword = snapshot.val(); });

// Evento para el login de administrador
document.getElementById('admin-lock').addEventListener('click', () => {
    if (isAdmin) { // Si ya es admin, cierra sesi√≥n
        isAdmin = false;
        loggedInPlayer = null;
        document.getElementById('login-info').textContent = 'Identif√≠cate para responder';
    } else { // Si no es admin, pide contrase√±a
        const pass = prompt('Introduce la contrase√±a de administrador:');
        if (pass === adminPassword) {
            isAdmin = true;
            loggedInPlayer = null;
            document.getElementById('login-info').textContent = 'Sesi√≥n iniciada como Administrador';
        } else if (pass) { alert('Contrase√±a incorrecta.'); }
    }
    renderUI(); // Actualiza la vista
});

// Evento para el login de jugador
document.getElementById('player-login').addEventListener('click', () => {
    if (!currentDbData || !currentDbData.jugadores) return;
    const accessCode = prompt('Introduce tu c√≥digo de acceso:');
    if (!accessCode) return;
    
    const playerIndex = currentDbData.jugadores.findIndex(p => p.password === accessCode);
    if (playerIndex > -1) { // Si se encuentra el jugador
        loggedInPlayer = {...currentDbData.jugadores[playerIndex], index: playerIndex};
        isAdmin = false;
        document.getElementById('login-info').textContent = `Sesi√≥n iniciada como: ${loggedInPlayer.nombre}`;
    } else {
        alert('C√≥digo de acceso no reconocido.');
    }
    renderUI(); // Actualiza la vista
});


// --- L√ìGICA PRINCIPAL Y EVENTOS ---

// Se ejecuta cuando el HTML est√° completamente cargado
document.addEventListener('DOMContentLoaded', function() {
    
    // Listener principal: se ejecuta cada vez que hay un cambio en la base de datos
    database.ref().on('value', async (snapshot) => {
        const data = snapshot.val();
        if (data && data.jugadores) {
            currentDbData = data;
            
            // Comprueba si es hora de resetear autom√°ticamente la asistencia (ej. despu√©s del partido)
            const ahora = getCurrentTime();
            const nextMatchDate = (currentDbData.matchInfo && currentDbData.matchInfo.nextMatchDate) ? new Date(currentDbData.matchInfo.nextMatchDate) : getNextWednesday();
            const resetTime = new Date(nextMatchDate);
            resetTime.setHours(22, 0, 0, 0);

            if (ahora > resetTime) {
                const newMatchDate = getNextWednesday();
                const updates = {
                    'refuerzos': null,
                    'matchInfo/nextMatchDate': newMatchDate.toISOString()
                };
                currentDbData.jugadores.forEach((_, index) => {
                    updates[`jugadores/${index}/status`] = 'pendiente';
                });
                await database.ref().update(updates); // Realiza el reseteo
            } else {
                renderUI(); // Si no es hora de resetear, simplemente renderiza la interfaz
            }
        }
    });

    // Listener de eventos en la tabla (usando delegaci√≥n de eventos)
    document.getElementById('tabla-jugadores').addEventListener('click', (e) => {
        // Si el clic fue en un bot√≥n de borrar jugador
        if (e.target.classList.contains('delete-player-btn')) {
            const fila = e.target.closest('tr');
            const index = parseInt(fila.dataset.index, 10);
            const jugador = currentDbData.jugadores[index];
            
            if (confirm(`¬øSeguro que quieres eliminar a ${jugador.nombre} de la plantilla?\nEsta acci√≥n es permanente.`)) {
                // Filtra el array de jugadores para quitar al seleccionado
                const updatedPlayers = currentDbData.jugadores.filter((_, i) => i !== index);
                // Sube el nuevo array a Firebase, sobreescribiendo el anterior
                database.ref('jugadores').set(updatedPlayers)
                    .then(() => alert(`${jugador.nombre} ha sido eliminado.`))
                    .catch(error => alert("Error al eliminar: " + error.message));
            }
        }
    });

    // Listener para guardar cambios en los inputs de la tabla
    document.getElementById('tabla-jugadores').addEventListener('change', (e) => {
        const fila = e.target.closest('tr');
        if(!fila || e.target.type !== 'radio') return; // Solo actuar en cambios de radio
        const index = fila.dataset.index;
        const updateData = {
            jugados: parseInt(fila.querySelector('.jugados').value),
            total: parseInt(fila.querySelector('.total').value),
            status: fila.querySelector('input[type="radio"]:checked').value,
            bajas: parseInt(fila.querySelector('.bajas').value)
        };
        database.ref(`jugadores/${index}`).update(updateData);
    });

    // Listeners del Modo Test
    document.getElementById('apply-test-date').addEventListener('click', () => {
        const dateValue = document.getElementById('test-date').value;
        simulatedTime = dateValue ? new Date(dateValue) : null;
        renderUI();
    });
    document.getElementById('reset-test-date').addEventListener('click', () => {
        simulatedTime = null;
        document.getElementById('test-date').value = '';
        renderUI();
    });

    // Listener del bot√≥n de reset manual (solo admin)
    document.getElementById('reset-button').addEventListener('click', () => {
        if (confirm('¬øPoner a todos los jugadores en "Pendiente"?')) {
            const updates = {};
            currentDbData.jugadores.forEach((_, index) => {
                updates[`jugadores/${index}/status`] = 'pendiente';
            });
            database.ref().update(updates);
        }
    });

    // Listener del bot√≥n para a√±adir refuerzos (amigos)
    document.getElementById('add-refuerzo-btn').addEventListener('click', () => {
        const nombreRefuerzo = document.getElementById('refuerzo-nombre').value.trim();
        if(nombreRefuerzo && (isAdmin || loggedInPlayer)) {
            const anadidoPor = isAdmin ? 'Admin' : loggedInPlayer.nombre;
            database.ref('refuerzos').push({ nombre: nombreRefuerzo, anadidoPor });
            document.getElementById('refuerzo-nombre').value = '';
        } else {
            alert("Debes identificarte para a√±adir un refuerzo.");
        }
    });
    
    // Listener para a√±adir un nuevo jugador a la plantilla (solo admin)
    document.getElementById('add-player-btn').addEventListener('click', () => {
        const newName = document.getElementById('new-player-name').value.trim();
        if (!newName) {
            alert("Por favor, introduce un nombre.");
            return;
        }
        const newPassword = prompt(`Introduce la contrase√±a para ${newName}:`);
        if (!newPassword) {
            alert("La contrase√±a no puede estar vac√≠a.");
            return;
        }

        const newPlayer = {
            nombre: newName,
            password: newPassword,
            status: "pendiente",
            jugados: 0,
            total: 0,
            bajas: 0
        };

        const updatedPlayers = [...currentDbData.jugadores, newPlayer];
        database.ref('jugadores').set(updatedPlayers)
            .then(() => {
                alert(`${newName} ha sido a√±adido a la plantilla.`);
                document.getElementById('new-player-name').value = '';
            })
            .catch(error => alert("Error al a√±adir jugador: " + error.message));
    });

    // Listener para borrar refuerzos (amigos)
    document.querySelector('.container').addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-refuerzo')) {
            const refKey = e.target.dataset.key;
            const refOwner = e.target.dataset.owner;
            if (isAdmin || (loggedInPlayer && loggedInPlayer.nombre === refOwner)) {
                if (refKey && confirm('¬øQuitar a este refuerzo de la lista?')) {
                    database.ref('refuerzos/' + refKey).remove();
                }
            } else {
                alert('Solo el admin o la persona que a√±adi√≥ el refuerzo puede borrarlo.');
            }
        }
    });
});


// --- FUNCIONES DE RENDERIZADO Y C√ÅLCULO ---

// Devuelve la hora actual o la simulada por el modo test
function getCurrentTime() {
    return simulatedTime ? new Date(simulatedTime) : new Date();
}

// Funci√≥n principal que llama a todas las dem√°s para dibujar la interfaz
function renderUI() {
    if (!currentDbData) return;
    document.getElementById('main-content').style.display = 'block';

    renderSummary();
    renderTable();
    applyVisibility();
}

// Dibuja el cuadro de resumen con la probabilidad
function renderSummary() {
    const { jugadores, refuerzos, matchInfo } = currentDbData;
    const matchDate = (matchInfo && matchInfo.nextMatchDate) ? new Date(matchInfo.nextMatchDate) : getNextWednesday();
    document.getElementById('match-date-title').textContent = `Partido del ${matchDate.toLocaleDateString('es-ES', { weekday: 'long', month: 'long', day: 'numeric' })}`;

    const JUGADORES_NECESARIOS = 10;
    const listaSi = [], listaPendiente = [], listaNo = [];
    const listaRefuerzos = refuerzos ? Object.entries(refuerzos) : [];

    jugadores.forEach(j => {
        if (j.status === 'si') listaSi.push(j);
        else if (j.status === 'no') listaNo.push(j);
        else listaPendiente.push(j);
    });

    let probabilidad, recomendacion, claseColor;
    let showRefuerzosForce = false;
    const totalConfirmados = listaSi.length + listaRefuerzos.length;
    
    // --- INICIO DEL ALGORITMO DE PROBABILIDAD ---
    if (totalConfirmados >= JUGADORES_NECESARIOS) {
        probabilidad = 100;
        claseColor = "verde";
        recomendacion = `¬°PARTIDO CONFIRMADO! Ya sois ${totalConfirmados}.`;
    } else {
        const ahora = getCurrentTime();
        let porcentajeRestante = 100 - (listaSi.length * 10);
        const jugadoresEnJuego = listaPendiente.length;
        
        let proyeccionPendientes = 0;
        if (jugadoresEnJuego > 0) {
            const pesoDinamico = porcentajeRestante / jugadoresEnJuego;
            listaPendiente.forEach(jugador => {
                const fiabilidad = (jugador.total > 0) ? (jugador.jugados / jugador.total) : 0;
                const factorFiabilidad = Math.max(0, fiabilidad);

                const mondayStart = new Date(matchDate);
                mondayStart.setDate(mondayStart.getDate() - 2);
                mondayStart.setHours(0, 0, 0, 0);

                const tuesdayEnd = new Date(mondayStart);
                tuesdayEnd.setDate(tuesdayEnd.getDate() + 1);
                tuesdayEnd.setHours(14, 0, 0, 0);

                let factorTiempo = 1.0;
                if (ahora > mondayStart) {
                    if (ahora < tuesdayEnd) {
                        const decay = (ahora - mondayStart) / (tuesdayEnd - mondayStart) * (1.0 - 0.33);
                        factorTiempo = 1.0 - decay;
                    } else {
                        factorTiempo = 0.33;
                    }
                }
                proyeccionPendientes += pesoDinamico * factorFiabilidad * factorTiempo;
            });
        }
        
        probabilidad = (listaSi.length * 10) + proyeccionPendientes;
        probabilidad += listaRefuerzos.length * 10;

        const decayStart = new Date(matchDate);
        decayStart.setDate(decayStart.getDate() - 1);
        decayStart.setHours(14, 0, 0, 0);
        const decayEnd = new Date(matchDate);

        let finalDecayActive = false;
        if (ahora > decayStart) {
            if (ahora < decayEnd) {
                const decayFactor = 1 - ( (ahora - decayStart) / (decayEnd - decayStart) );
                probabilidad *= decayFactor;
                finalDecayActive = true;
            } else {
                probabilidad = 0;
            }
        }
        
        if (probabilidad >= 95) { claseColor = "verde"; recomendacion = ""; }
        else if (probabilidad >= 70) { claseColor = "ambar"; recomendacion = ""; }
        else if (probabilidad >= 40) { claseColor = "ambar"; recomendacion = "‚ö†Ô∏è ¬°Atenci√≥n! La cosa est√° justa."; }
        else { claseColor = "rojo"; recomendacion = "üî• ¬°Peligro! Conviene buscar gente."; }

        if (finalDecayActive) {
            recomendacion += "<br><small>‚ö†Ô∏è ¬°El tiempo se agota! La probabilidad disminuye cada hora.</small>";
        }
    }
    
    probabilidad = Math.min(100, Math.max(0, probabilidad));

    const hayJugadorConBajas = listaSi.some(j => (j.bajas || 0) > 0);
    if(hayJugadorConBajas) {
        recomendacion += '<br><small style="font-weight: bold; opacity: 0.9;">AVISO: Hay apuntados con historial de bajas.</small>';
    }
    
    let isRefuerzosOpen = false;
    if (isAdmin) {
        isRefuerzosOpen = true;
    } else if (totalConfirmados >= 10) {
        isRefuerzosOpen = false;
    } else if (loggedInPlayer) {
        const ahora = getCurrentTime();
        const tuesdayActivationTime = new Date(matchDate);
        tuesdayActivationTime.setDate(tuesdayActivationTime.getDate() - 1);
        tuesdayActivationTime.setHours(14, 0, 0, 0);

        const mondayActivationTime = new Date(matchDate);
        mondayActivationTime.setDate(mondayActivationTime.getDate() - 2);
        mondayActivationTime.setHours(14, 0, 0, 0);

        if (showRefuerzosForce) {
            isRefuerzosOpen = true;
        } else if (ahora >= tuesdayActivationTime) {
            isRefuerzosOpen = true;
        } else if (ahora >= mondayActivationTime && probabilidad <= 80) {
            isRefuerzosOpen = true;
        }
    }

    document.getElementById('refuerzos-section').style.display = isRefuerzosOpen ? 'block' : 'none';

    if (isRefuerzosOpen && !showRefuerzosForce) {
        recomendacion += '<br><small style="font-style: italic;">Ya est√° abierta la inscripci√≥n de amigos.</small>';
    }

    const siHtml = listaSi.map(j => `<li><span class="status-icon icon-si">‚úî</span> ${j.nombre}</li>`).join('');
    const refuerzosHtml = listaRefuerzos.map(([key, ref]) => {
        const puedeBorrar = isAdmin || (loggedInPlayer && loggedInPlayer.nombre === ref.anadidoPor);
        const delBtn = puedeBorrar ? `<span class="delete-refuerzo" data-key="${key}" data-owner="${ref.anadidoPor}">üóëÔ∏è</span>` : '';
        return `<li><span class="status-icon icon-si">‚úî</span> <i>${ref.nombre} (Amigo de ${ref.anadidoPor})</i> ${delBtn}</li>`;
    }).join('');
    const pendienteHtml = listaPendiente.map(j => `<li><span class="status-icon icon-pendiente">?</span> ${j.nombre}</li>`).join('');
    const noHtml = listaNo.map(j => `<li><span class="status-icon icon-no">‚úñ</span> ${j.nombre}</li>`).join('');

    const resultadoDiv = document.getElementById('resultado');
    resultadoDiv.className = 'resultado ' + claseColor;
    resultadoDiv.innerHTML = `<p class="probabilidad">${probabilidad.toFixed(0)}% <span style="font-size: 0.4em; opacity: 0.8; font-weight: 400;">posibilidades de jugar</span></p><p class="recomendacion">${recomendacion}</p>
        <div class="resumen"><strong>Respuestas (${totalConfirmados} confirmados):</strong>
        <ul class="lista-apuntados">${siHtml}${refuerzosHtml}${pendienteHtml}${noHtml}</ul></div>`;
}

// Dibuja la tabla de jugadores
function renderTable() {
    const tablaBody = document.querySelector("#tabla-jugadores tbody");
    tablaBody.innerHTML = '';
    currentDbData.jugadores.forEach((jugador, index) => {
        const fiabilidad = jugador.total > 0 ? ((jugador.jugados || 0) / jugador.total * 100).toFixed(0) + '%' : '0%';
        const status = jugador.status || 'pendiente';
        const fila = `
            <tr data-index="${index}">
                <td>${jugador.nombre}</td>
                <td><div class="status-radio">
                    <label><input type="radio" name="status-${index}" value="si" ${status === 'si' ? 'checked' : ''}> S√≠</label>
                    <label><input type="radio" name="status-${index}" value="no" ${status === 'no' ? 'checked' : ''}> No</label>
                    <label><input type="radio" name="status-${index}" value="pendiente" ${status === 'pendiente' ? 'checked' : ''}> Pendiente</label>
                </div></td>
                <td class="admin-only"><input type="number" class="jugados" value="${jugador.jugados || 0}" min="0"></td>
                <td class="admin-only"><input type="number" class="total" value="${jugador.total || 0}" min="0"></td>
                <td class="admin-only"><input type="number" class="bajas" value="${jugador.bajas || 0}" min="0"></td>
                <td class="fiabilidad">${fiabilidad}</td>
                <td class="admin-only"><button class="delete-player-btn" title="Eliminar a ${jugador.nombre}">üóëÔ∏è</button></td>
            </tr>`;
        tablaBody.innerHTML += fila;
    });
}

// Aplica las reglas de visibilidad seg√∫n el estado de login
function applyVisibility() {
    const testSection = document.getElementById('admin-test-section');
    testSection.style.display = (isAdmin || loggedInPlayer) ? 'block' : 'none';
    if(isAdmin || loggedInPlayer) {
        const timeDisplay = document.getElementById('current-time-display');
        const now = getCurrentTime();
        timeDisplay.textContent = `Hora del sistema: ${now.toLocaleString('es-ES', { dateStyle: 'full', timeStyle: 'short' })} ${simulatedTime ? '(SIMULADA)' : ''}`;
    }

    document.getElementById('tabla-jugadores').style.display = (isAdmin || loggedInPlayer) ? '' : 'none';
    document.body.classList.toggle('admin-view', isAdmin);

    document.querySelectorAll('#tabla-jugadores tbody tr').forEach(fila => {
        const index = parseInt(fila.dataset.index, 10);
        const isPlayerRow = loggedInPlayer && loggedInPlayer.index === index;
        if (loggedInPlayer && !isAdmin) {
            fila.style.display = isPlayerRow ? '' : 'none';
        }
        fila.querySelectorAll('input').forEach(input => {
             input.disabled = !(isAdmin || isPlayerRow);
        });
    });
}

// Calcula la fecha del pr√≥ximo mi√©rcoles
function getNextWednesday() {
    const d = getCurrentTime();
    const today = d.getDay();
    const offset = (3 - today + 7) % 7;
    const newDate = new Date(d);
    newDate.setDate(d.getDate() + offset);
    newDate.setHours(21, 0, 0, 0);
    if (offset === 0 && d > newDate) {
        newDate.setDate(newDate.getDate() + 7);
    }
    return newDate;
}
</script>
</body>
</html>
