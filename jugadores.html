<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Partido de Fútbol</title>
    <style>
        /* Estilos generales */
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:#f4f7f6;color:#333;margin:0;padding:10px}
        .container{max-width:800px;margin:auto;background-color:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
        
        /* Encabezados */
        h1,h2{text-align:center;color:#1a73e8}
        h1{font-size:1.8em;display:flex;align-items:center;justify-content:center;gap:15px}
        .date-header{display:flex;justify-content:center;align-items:center;gap:15px;}
        h2{border-bottom:2px solid #1a73e8;padding-bottom:10px;margin-top:30px; flex-grow: 1;}
        
        /* Iconos y etiquetas de Login */
        .login-controls{display:flex;justify-content:center;gap:30px;align-items:flex-start;}
        .login-icon-wrapper{display:flex;flex-direction:column;align-items:center;cursor:pointer;}
        .login-label{font-size:0.7em;font-weight:600;color:#555;margin-top:2px;}
        
        /* Tabla de jugadores */
        table{width:100%;border-collapse:collapse;margin-top:20px}
        th,td{padding:12px;text-align:left;border-bottom:1px solid #ddd}
        th{background-color:#f2f2f2}
        .summary-player-name {cursor:pointer;text-decoration:underline;text-decoration-style:dotted;text-decoration-thickness:1px;}
        .summary-player-name:hover {color:#1a73e8;}
        
        /* Entradas y botones */
        input[type=number]{width:60px;padding:5px;border:1px solid #ccc;border-radius:4px;text-align:center}
        input[type=text]{padding:8px;border:1px solid #ccc;border-radius:4px;width:60%}
        .status-radio{display:flex;gap:10px;justify-content:flex-start}
        
        /* Cuadro de resumen */
        .resultado, #pending-activation{padding:20px;margin-top:10px;border-radius:8px;text-align:center;color:#fff;transition:background-color .3s ease}
        .probabilidad{font-size:2.5em;font-weight:700;margin:0}
        .recomendacion{font-size:1.1em;font-weight:400;margin-top:10px}
        .resumen,.lista-apuntados{font-size:.9em;font-weight:400;margin-top:15px;opacity:.9;border-top:1px solid rgba(255,255,255,.3);padding-top:10px}
        .lista-apuntados{text-align:left;list-style:none;padding-left:0;}
        .lista-apuntados li{display:flex;align-items:center;padding:3px 0;}
        
        /* Icono de información */
        .info-icon-svg {display:inline-block;vertical-align:middle;margin-left:8px;cursor:pointer;opacity:1;transition:transform 0.2s ease-in-out;fill:#1a73e8;height:18px;width:18px;}
        .info-icon-svg:hover {transform:scale(1.1);}
        
        /* --- MODIFICADO: Estilos para el botón de WhatsApp (posición fija) --- */
        #whatsapp-button{position:fixed;bottom:20px;right:20px;background-color:#25D366;color:white;border:none;border-radius:50%;width:50px;height:50px;display:none;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,.3);transition:transform .2s;z-index:100;}
        #whatsapp-button:hover{transform:scale(1.1);}
        #whatsapp-button svg{width:28px;height:28px;fill:white;}

        /* Iconos de acción */
        .delete-refuerzo, .delete-player-btn{cursor:pointer;font-size:1.1em;opacity:0.7;}
        .delete-refuerzo{margin-left:auto;}
        .delete-refuerzo:hover, .delete-player-btn:hover{opacity:1;}
        .delete-player-btn {background:none; border:none; padding:0 5px; font-size:1.2em;}
        
        /* Colores del resumen */
        .verde{background-color:#28a745}
        .ambar{background:linear-gradient(45deg,#ffc107,#ff9800);color:#333}
        .rojo{background:linear-gradient(45deg,#dc3545,#b71c1c)}
        #pending-activation{background-color:#6c757d;}
        
        /* Visibilidad de Admin */
        .admin-only{display:none}
        .admin-view .admin-only{display:table-cell !important;}
        .admin-view .admin-button{display:block !important;}
        .admin-view #add-player-section{display:block !important;}

        /* Iconos de estado */
        #admin-lock, #player-login{cursor:pointer;font-size:1.5em}
        #login-info{font-size:0.8em;color:#333;text-align:center;margin-top:10px}
        
        /* Secciones de admin */
        #refuerzos-section, #add-player-section{margin-top:25px;padding:15px;border:1px solid #eee;border-radius:8px;display:none}
        .status-icon{display:inline-flex;justify-content:center;align-items:center;width:1.4em;height:1.4em;border-radius:50%;color:#fff;font-weight:700;margin-right:8px;border:2px solid black;font-size:.9em;text-shadow:1px 1px 2px rgba(0,0,0,.5);}
        .icon-si{background-color:#28a745}
        .icon-pendiente{background-color:#ffc107;color:#333}
        .icon-no{background-color:#dc3545}
        
        /* Modo Test */
        #admin-test-section button{padding:5px 10px;margin-left:5px;}

        /* Ventanas Modales */
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:flex-start;padding-top:10vh;z-index:1000}
        .modal-box{background:#fff;padding:25px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.3);text-align:center;width:90%;max-width:400px;color:#333}
        .modal-title{font-size:1.4em;font-weight:600;margin-top:0;margin-bottom:15px;color:#1a73e8}
        .modal-message{font-size:1em;line-height:1.5;margin-bottom:25px;white-space:pre-wrap;text-align:center;}
        .modal-input{width:80%;padding:10px;margin-bottom:20px;border:1px solid #ccc;border-radius:5px;font-size:1em;}
        .modal-buttons{display:flex;justify-content:center;gap:15px;}
        .modal-button{padding:10px 20px;border:none;border-radius:5px;background-color:#1a73e8;color:white;font-size:1em;cursor:pointer}
        .modal-button.cancel{background-color:#6c757d;}
        .modal-button:hover{opacity:0.85;}

        /* Estilos para móviles */
        @media screen and (max-width:600px){
            body{padding:5px}.container{padding:15px}h1{font-size:1.5em}.probabilidad{font-size:2em}.recomendacion{font-size:1em}
            table,thead,tbody,th,td,tr{display:block}
            thead tr{position:absolute;top:-9999px;left:-9999px}
            tr{border:1px solid #ccc;margin-bottom:15px;border-radius:5px;padding:5px}
            td{border:none;border-bottom:1px solid #eee;position:relative;padding-left:50%;text-align:right}
            td:before{position:absolute;left:6px;width:45%;padding-right:10px;white-space:nowrap;text-align:left;font-weight:700}
            td:nth-of-type(1):before{content:"Nombre"}td:nth-of-type(2):before{content:"Estado"}td:nth-of-type(3):before{content:"Bajas"}td:nth-of-type(4):before{content:"Fiabilidad"}td:nth-of-type(5):before{content:"Acción"}
            .status-radio{justify-content:flex-end}input[type=number]{width:70px}
            .admin-view .admin-only{display:block !important;}
        }
    </style>
</head>
<body>

<div class="container">
    <h1>
        <div class="login-controls">
            <div class="login-icon-wrapper" id="admin-lock-wrapper">
                <span id="admin-lock">🔓</span>
                <span class="login-label">Admin</span>
            </div>
        </div>
        Gestor de Partido
        <div class="login-controls">
            <div class="login-icon-wrapper" id="player-login-wrapper">
                <span id="player-login">👤</span>
                <span class="login-label">Login</span>
            </div>
        </div>
    </h1>
    <div id="login-info">Identifícate para responder</div>
    
    <div class="date-header">
        <h2 id="match-date-title">Cargando...</h2>
    </div>

    <div id="main-content" style="display: none;">
        <div id="pending-activation" style="display: none;">
            <h3>Partido pendiente de activarse</h3>
            <p>Vuelva a conectarse en unas horas.</p>
        </div>
        
        <button id="archive-button" class="admin-only admin-button" style="display:none; width: 100%; padding: 10px; margin-bottom: 15px; background-color: #1a73e8; color: white; border: none; border-radius: 5px; cursor: pointer;">Archivar y Activar Siguiente Partido</button>
        
        <div id="resultado"></div>
        
        <div id="refuerzos-section">
            <h4>Añadir Refuerzos</h4>
            <input type="text" id="refuerzo-nombre" placeholder="Nombre del refuerzo...">
            <button id="add-refuerzo-btn">Añadir</button>
        </div>
        
        <table id="tabla-jugadores">
            <thead><tr><th>Nombre</th><th>Estado</th><th class="admin-only">Bajas</th><th>Fiabilidad</th><th class="admin-only">Acción</th></tr></thead>
            <tbody></tbody>
        </table>

        <div id="add-player-section" class="admin-only">
            <h4>Añadir Nuevo Jugador a la Plantilla</h4>
            <input type="text" id="new-player-name" placeholder="Nombre del nuevo jugador...">
            <button id="add-player-btn">Añadir</button>
        </div>

        <div id="admin-test-section" style="display: none; margin-top: 20px; padding: 15px; border: 2px dashed #ccc; border-radius: 8px;">
            <h4 style="margin-top:0;">Modo Test</h4>
            <label for="test-date">Simular Fecha y Hora:</label>
            <input type="datetime-local" id="test-date">
            <button id="apply-test-date">Aplicar</button>
            <button id="reset-test-date">Hora Real</button>
            <p id="current-time-display" style="font-size: 0.9em; color: #555; margin-top: 10px;"></p>
        </div>
    </div>
</div>

<a id="whatsapp-button" title="Abrir grupo de WhatsApp">
    <svg viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.61 15.31 3.4 16.78L2 22L7.33 20.62C8.75 21.35 10.35 21.79 12.04 21.79C17.5 21.79 21.95 17.34 21.95 11.88C21.95 6.42 17.5 2 12.04 2M12.04 3.64C16.56 3.64 20.21 7.29 20.21 11.81C20.21 16.33 16.56 19.98 12.04 19.98C10.53 19.98 9.11 19.59 7.89 18.91L7.44 18.66L3.93 19.58L4.87 16.16L4.59 15.69C3.83 14.38 3.39 12.89 3.39 11.31C3.39 6.79 7.04 3.14 11.56 3.14H12.04M8.88 7.33C8.71 6.84 8.54 6.84 8.38 6.84C8.22 6.84 8 6.84 7.79 6.84C7.58 6.84 7.31 6.91 7.09 7.16C6.87 7.41 6.22 8 6.22 9.24C6.22 10.48 7.11 11.65 7.26 11.84C7.41 12.03 8.81 14.34 11.1 15.31C13.39 16.28 13.83 16.08 14.24 16.03C14.65 15.98 15.53 15.48 15.74 14.89C15.95 14.3 15.95 13.81 15.89 13.7C15.83 13.59 15.67 13.53 15.41 13.41C15.15 13.29 14.09 12.76 13.88 12.68C13.67 12.6 13.53 12.57 13.39 12.81C13.25 13.05 12.81 13.59 12.67 13.73C12.53 13.87 12.39 13.89 12.18 13.78C11.97 13.67 11.04 13.34 9.91 12.35C9.01 11.58 8.41 10.64 8.27 10.4C8.13 10.16 8.24 10.04 8.35 9.93C8.45 9.82 8.58 9.66 8.7 9.53C8.82 9.4 8.87 9.29 8.95 9.11C9.03 8.93 8.98 8.78 8.92 8.66C8.86 8.54 8.46 7.53 8.27 7.33L8.88 7.33Z" /></svg>
</a>

<div id="custom-alert-modal" class="modal-overlay">
    <div class="modal-box">
        <h3 id="modal-title" class="modal-title"></h3>
        <div id="modal-message" class="modal-message"></div>
        <button id="modal-button" class="modal-button">Aceptar</button>
    </div>
</div>

<div id="custom-prompt-modal" class="modal-overlay">
    <div class="modal-box">
        <h3 id="prompt-title" class="modal-title"></h3>
        <input id="prompt-input" class="modal-input" type="password">
        <div class="modal-buttons">
            <button id="prompt-cancel" class="modal-button cancel">Cancelar</button>
            <button id="prompt-ok" class="modal-button">Aceptar</button>
        </div>
    </div>
</div>


<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
// --- CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyAeUfYINReyta5uNZd8sDCylju0nE7oy-A",
  authDomain: "entrenamientos-5f314.firebaseapp.com",
  databaseURL: "https://entrenamientos-5f314-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "entrenamientos-5f314",
  storageBucket: "entrenamientos-5f314.firebasestorage.app",
  messagingSenderId: "322454738753",
  appId: "G-SGS7EYBFTZ"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// --- VARIABLES GLOBALES Y CONFIGURACIÓN ---
const WHATSAPP_GROUP_LINK = 'https://chat.whatsapp.com/HkJ7ha85RvsHl4URkdwFcd?mode=ems_copy_t';

let adminPassword = "";
let isAdmin = false;
let loggedInPlayer = null;
let currentDbData = null;
let simulatedTime = null; 
let isMatchPendingActivation = false;

// --- Sistema de Ventanas Modales Personalizadas ---
function showCustomAlert(title, message) {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-message').innerHTML = message.replace(/\n/g, '<br>');
    document.getElementById('custom-alert-modal').style.display = 'flex';
}
document.getElementById('modal-button').addEventListener('click', () => {
    document.getElementById('custom-alert-modal').style.display = 'none';
});
document.getElementById('custom-alert-modal').addEventListener('click', (e) => {
    if (e.target.id === 'custom-alert-modal') document.getElementById('custom-alert-modal').style.display = 'none';
});

function showCustomPrompt(title) {
    return new Promise((resolve) => {
        const modal = document.getElementById('custom-prompt-modal');
        const input = document.getElementById('prompt-input');
        const okBtn = document.getElementById('prompt-ok');
        const cancelBtn = document.getElementById('prompt-cancel');
        
        document.getElementById('prompt-title').textContent = title;
        input.value = '';
        modal.style.display = 'flex';
        input.focus();

        const close = (value) => {
            modal.style.display = 'none';
            okBtn.onclick = null;
            cancelBtn.onclick = null;
            input.onkeydown = null;
            resolve(value);
        };

        okBtn.onclick = () => close(input.value);
        cancelBtn.onclick = () => close(null);
        input.onkeydown = (e) => { if (e.key === 'Enter') close(input.value); };
    });
}

// --- LÓGICA DE LOGIN ---
database.ref('config/password').once('value', (snapshot) => { adminPassword = snapshot.val(); });

document.getElementById('admin-lock-wrapper').addEventListener('click', async () => {
    if (isAdmin) {
        isAdmin = false;
        loggedInPlayer = null;
        document.getElementById('login-info').textContent = 'Identifícate para responder';
        renderUI();
    } else {
        const pass = await showCustomPrompt('Contraseña de Administrador');
        if (pass === adminPassword) {
            isAdmin = true;
            loggedInPlayer = null;
            document.getElementById('login-info').textContent = 'Sesión iniciada como Administrador';
        } else if (pass !== null) { 
            showCustomAlert('Error', 'Contraseña incorrecta.'); 
        }
        renderUI();
    }
});

document.getElementById('player-login-wrapper').addEventListener('click', async () => {
    if (!currentDbData || !currentDbData.jugadores) return;
    const accessCode = await showCustomPrompt('Código de Acceso');
    if (!accessCode) return;
    
    const jugadores = currentDbData.jugadores;
    const playerKey = Object.keys(jugadores).find(key => jugadores[key].password === accessCode);

    if (playerKey) {
        loggedInPlayer = {...jugadores[playerKey], key: playerKey};
        isAdmin = false;
        document.getElementById('login-info').textContent = `Sesión iniciada como: ${loggedInPlayer.nombre}`;
    } else {
        showCustomAlert('Error', 'Código de acceso no reconocido.');
    }
    renderUI();
});


// --- LÓGICA PRINCIPAL Y EVENTOS ---
document.addEventListener('DOMContentLoaded', function() {
    // Listener principal de Firebase
    database.ref().on('value', (snapshot) => {
        const data = snapshot.val();
        if (data && data.jugadores) {
            currentDbData = data;
            const ahora = getCurrentTime();
            const nextMatchDate = (currentDbData.matchInfo && currentDbData.matchInfo.nextMatchDate) ? new Date(currentDbData.matchInfo.nextMatchDate) : getNextWednesday();
            const activationTimeLimit = new Date(nextMatchDate);
            activationTimeLimit.setHours(22, 0, 0, 0); 
            isMatchPendingActivation = ahora > activationTimeLimit;
            renderUI();
        }
    });

    // Delegación de eventos para la tabla
    document.getElementById('tabla-jugadores').addEventListener('click', (e) => {
        const fila = e.target.closest('tr');
        if (!fila) return;
        const playerKey = fila.dataset.key;
        if (!playerKey) return;

        if (e.target.classList.contains('delete-player-btn')) {
            const jugador = currentDbData.jugadores[playerKey];
            if (confirm(`¿Seguro que quieres eliminar a ${jugador.nombre} de la plantilla?\nEsta acción es permanente.`)) {
                database.ref('jugadores/' + playerKey).remove()
                    .then(() => showCustomAlert('Información', `${jugador.nombre} ha sido eliminado.`))
                    .catch(error => showCustomAlert('Error', "Error al eliminar: " + error.message));
            }
        }
    });
    
    document.getElementById('tabla-jugadores').addEventListener('change', (e) => {
        const fila = e.target.closest('tr');
        if (!fila) return;
        const playerKey = fila.dataset.key;
        const target = e.target;

        if (target.classList.contains('bajas')) {
            database.ref(`jugadores/${playerKey}/bajas`).set(parseInt(target.value, 10));
        } else if (target.name.startsWith('status-')) {
             database.ref(`jugadores/${playerKey}/status`).set(target.value);
        }
    });

    // Listeners del Modo Test
    document.getElementById('apply-test-date').addEventListener('click', () => {
        const dateValue = document.getElementById('test-date').value;
        simulatedTime = dateValue ? new Date(dateValue) : null;
        const ahora = getCurrentTime();
        const nextMatchDate = (currentDbData.matchInfo && currentDbData.matchInfo.nextMatchDate) ? new Date(currentDbData.matchInfo.nextMatchDate) : getNextWednesday();
        const activationTimeLimit = new Date(nextMatchDate);
        activationTimeLimit.setHours(22, 0, 0, 0); 
        isMatchPendingActivation = (ahora > activationTimeLimit);
        renderUI();
    });
    document.getElementById('reset-test-date').addEventListener('click', () => {
        simulatedTime = null;
        document.getElementById('test-date').value = '';
        const ahora = getCurrentTime();
        const nextMatchDate = (currentDbData.matchInfo && currentDbData.matchInfo.nextMatchDate) ? new Date(currentDbData.matchInfo.nextMatchDate) : getNextWednesday();
        const activationTimeLimit = new Date(nextMatchDate);
        activationTimeLimit.setHours(22, 0, 0, 0); 
        isMatchPendingActivation = (ahora > activationTimeLimit);
        renderUI();
    });

    document.getElementById('archive-button').addEventListener('click', async () => {
        if (!isAdmin || !isMatchPendingActivation) return;
        if (!confirm('¿Estás seguro de que quieres archivar este partido y activar el siguiente?')) return;

        const { jugadores, refuerzos, matchInfo } = currentDbData;
        const oldMatchDate = (matchInfo && matchInfo.nextMatchDate) ? new Date(matchInfo.nextMatchDate) : getNextWednesday();
        const matchKey = oldMatchDate.toISOString().replace(/\..+/, '').replace(/[:T]/g, '-');

        const listaSi = Object.values(jugadores).filter(j => j.status === 'si');
        const listaRefuerzos = refuerzos ? Object.values(refuerzos) : [];
        const totalConfirmados = listaSi.length + listaRefuerzos.length;

        const historialJugadores = {};
        Object.keys(jugadores).forEach(key => {
            historialJugadores[key] = {
                nombre: jugadores[key].nombre,
                status: jugadores[key].status === 'pendiente' ? 'no' : jugadores[key].status
            };
        });

        const archiveData = {
            jugadores: historialJugadores,
            refuerzos: refuerzos || null,
            cancelado: totalConfirmados < 10,
            con_extras: totalConfirmados >= 10 && listaSi.length < 10,
        };
        
        const updates = {};
        updates[`/historial/${matchKey}`] = archiveData;
        
        Object.keys(jugadores).forEach(key => {
            updates[`/jugadores/${key}/status`] = 'pendiente';
        });

        updates['/refuerzos'] = null;
        updates['/matchInfo/nextMatchDate'] = getNextWednesday(true).toISOString();

        try {
            await database.ref().update(updates);
            showCustomAlert('Información', 'Partido archivado y nuevo partido activado correctamente.');
        } catch (error) {
            showCustomAlert('Error', 'Error al archivar el partido: ' + error.message);
        }
    });

    document.getElementById('add-refuerzo-btn').addEventListener('click', () => {
        const nombreRefuerzo = document.getElementById('refuerzo-nombre').value.trim();
        if(nombreRefuerzo && (isAdmin || loggedInPlayer)) {
            const anadidoPor = isAdmin ? 'Admin' : loggedInPlayer.nombre;
            database.ref('refuerzos').push({ nombre: nombreRefuerzo, anadidoPor });
            document.getElementById('refuerzo-nombre').value = '';
        } else {
            showCustomAlert('Aviso', "Debes identificarte para añadir un refuerzo.");
        }
    });
    
    document.getElementById('add-player-btn').addEventListener('click', async () => {
        const newName = document.getElementById('new-player-name').value.trim();
        if (!newName) { return showCustomAlert('Aviso', "Por favor, introduce un nombre."); }
        const newPassword = await showCustomPrompt(`Contraseña para ${newName}`);
        if (!newPassword) { return; }
        const newPlayer = { nombre: newName, password: newPassword, status: "pendiente", bajas: 0 };
        
        database.ref('jugadores').push(newPlayer)
            .then(() => {
                showCustomAlert('Información', `${newName} ha sido añadido a la plantilla.`);
                document.getElementById('new-player-name').value = '';
            })
            .catch(error => showCustomAlert('Error', "Error al añadir jugador: " + error.message));
    });
    
    // Listener principal del contenedor para varios eventos
    document.querySelector('body').addEventListener('click', function(e) {
        if (e.target.closest('.delete-refuerzo')) {
            const refuerzoElement = e.target.closest('.delete-refuerzo');
            const refKey = refuerzoElement.dataset.key;
            const refOwner = refuerzoElement.dataset.owner;
            if (isAdmin || (loggedInPlayer && loggedInPlayer.nombre === refOwner)) {
                if (refKey && confirm('¿Quitar a este refuerzo de la lista?')) {
                    database.ref('refuerzos/' + refKey).remove();
                }
            } else {
                showCustomAlert('Aviso', 'Solo el admin o la persona que añadió el refuerzo puede borrarlo.');
            }
        }
        else if (e.target.closest('#prob-info-icon')) {
            const history = currentDbData.historial || {};
            const allMatches = Object.values(history);
            const totalMatches = allMatches.length;
            const canceladosCount = allMatches.filter(m => m.cancelado).length;
            const conExtrasCount = allMatches.filter(m => m.con_extras).length;
            const playedMatches = totalMatches - canceladosCount;

            const message = `Probabilidad basada en los datos históricos de los últimos cuatro partidos.\n\n` +
                          `<strong>ESTADÍSTICAS TEMPORADA 25-26:</strong>\n` +
                          `Partidos totales: ${totalMatches}\n` +
                          `Partidos jugados: ${playedMatches}\n` +
                          `Partidos cancelados: ${canceladosCount}\n` +
                          `Partidos jugados gracias a amigos: ${conExtrasCount}`;
            showCustomAlert('Información del Partido', message);
        }
        else if (e.target.classList.contains('summary-player-name')) {
            const playerKey = e.target.dataset.key;
            if (playerKey) {
                showPlayerReliability(playerKey);
            }
        }
        else if (e.target.closest('#whatsapp-button')) {
            e.preventDefault();
            if (WHATSAPP_GROUP_LINK.includes('TU_ENLACE_AQUI')) {
                showCustomAlert('Aviso', 'El enlace de WhatsApp aún no ha sido configurado en el script.');
            } else {
                window.open(WHATSAPP_GROUP_LINK, '_blank');
            }
        }
    });
});


// --- FUNCIONES AUXILIARES Y DE CÁLCULO ---
function getCurrentTime() { return simulatedTime ? new Date(simulatedTime) : new Date(); }

function showPlayerReliability(playerKey) {
    if (!currentDbData || !currentDbData.jugadores[playerKey]) return;

    const history = currentDbData.historial || {};
    const playerName = currentDbData.jugadores[playerKey].nombre;
    
    const last4Matches = Object.keys(history).sort().slice(-4);
    let attendedLast4 = 0;
    last4Matches.forEach(matchKey => {
        if (history[matchKey].jugadores?.[playerKey]?.status === 'si') {
            attendedLast4++;
        }
    });
    const reliabilityLast4 = last4Matches.length > 0 ? (attendedLast4 / last4Matches.length * 100).toFixed(0) : 0;

    const allMatches = Object.keys(history);
    let attendedAllTime = 0;
    let answeredAllTime = 0;
    allMatches.forEach(matchKey => {
        const playerStatus = history[matchKey].jugadores?.[playerKey]?.status;
        if (playerStatus === 'si') {
            attendedAllTime++;
            answeredAllTime++;
        } else if (playerStatus === 'no') {
            answeredAllTime++;
        }
    });
    const reliabilityAllTime = answeredAllTime > 0 ? (attendedAllTime / answeredAllTime * 100).toFixed(0) : 0;

    const message = `<strong>Últimos 4 Partidos:</strong>\n` +
                  `Asistencias: ${attendedLast4} de ${last4Matches.length}\n` +
                  `Fiabilidad: ${reliabilityLast4}%\n\n` +
                  `<strong>Temporada 25-26:</strong>\n` +
                  `Asistencias: ${attendedAllTime} de ${allMatches.length}\n` +
                  `Fiabilidad (Global): ${reliabilityAllTime}%`;
                  
    showCustomAlert(`Fiabilidad de ${playerName}`, message);
}

// --- FUNCIONES DE RENDERIZADO ---
function renderUI() {
    if (!currentDbData) return;
    document.getElementById('main-content').style.display = 'block';

    if (isMatchPendingActivation && !isAdmin) {
        document.getElementById('pending-activation').style.display = 'block';
        document.getElementById('resultado').style.display = 'none';
        document.getElementById('tabla-jugadores').style.display = 'none';
        document.getElementById('refuerzos-section').style.display = 'none';
    } else {
        document.getElementById('pending-activation').style.display = 'none';
        document.getElementById('resultado').style.display = 'block';
        renderSummary();
        renderTable();
    }
    applyVisibility();
}

function renderSummary() {
    const { jugadores, refuerzos, matchInfo, historial } = currentDbData;
    const matchDate = (matchInfo && matchInfo.nextMatchDate) ? new Date(matchInfo.nextMatchDate) : getNextWednesday();
    document.getElementById('match-date-title').textContent = `Partido del ${matchDate.toLocaleDateString('es-ES', { weekday: 'long', month: 'long', day: 'numeric' })}`;

    const JUGADORES_NECESARIOS = 10;
    const listaSi = [], listaPendiente = [], listaNo = [];
    
    const jugadoresObj = jugadores || {};
    Object.keys(jugadoresObj).forEach(key => {
        const j = {...jugadoresObj[key], key: key};
        if (j.status === 'si') listaSi.push(j);
        else if (j.status === 'no') listaNo.push(j);
        else listaPendiente.push(j);
    });

    const listaRefuerzos = refuerzos ? Object.entries(refuerzos) : [];
    
    let probabilidad, recomendacion, claseColor, overrideHtml = null;
    let showRefuerzosForce = false;
    const totalConfirmados = listaSi.length + listaRefuerzos.length;
    const maximoPosiblePlantilla = listaSi.length + listaPendiente.length;

    if (totalConfirmados >= JUGADORES_NECESARIOS) {
        claseColor = "verde";
        recomendacion = `Ya sois ${totalConfirmados}.`;
        overrideHtml = `<p class="probabilidad" style="font-size: 1.8em; line-height: 1.2;">Partido Confirmado</p>`;
    } else if (maximoPosiblePlantilla < JUGADORES_NECESARIOS) {
        claseColor = "rojo";
        const faltan = JUGADORES_NECESARIOS - totalConfirmados;
        overrideHtml = `<p class="probabilidad" style="font-size: 1.5em; line-height: 1.2;">Partido en Riesgo</p>
                        <p class="recomendacion">Imposible llegar a 10 con la plantilla. Se necesitan ${faltan} refuerzo(s).</p>`;
        showRefuerzosForce = true;
    } else {
        const ahora = getCurrentTime();
        const last4MatchesKeys = Object.keys(historial || {}).sort().slice(-4);
        let proyeccionPendientes = 0;
        
        listaPendiente.forEach(jugador => {
            let attended = 0;
            last4MatchesKeys.forEach(matchKey => {
                if (historial[matchKey].jugadores?.[jugador.key]?.status === 'si') attended++;
            });
            const fiabilidadReal = last4MatchesKeys.length > 0 ? (attended / last4MatchesKeys.length) : 0;
            const pisoFiabilidad = 0.1;
            const fiabilidad = Math.max(fiabilidadReal, pisoFiabilidad);

            const mondayStart = new Date(matchDate);
            mondayStart.setDate(mondayStart.getDate() - 2);
            mondayStart.setHours(0, 0, 0, 0);
            const tuesdayEnd = new Date(mondayStart);
            tuesdayEnd.setDate(tuesdayEnd.getDate() + 1);
            tuesdayEnd.setHours(14, 0, 0, 0);
            let factorTiempo = 1.0;
            if (ahora > mondayStart) {
                if (ahora < tuesdayEnd) factorTiempo = 1.0 - ((ahora - mondayStart) / (tuesdayEnd - mondayStart) * (1.0 - 0.33));
                else factorTiempo = 0.33;
            }
            proyeccionPendientes += 10 * fiabilidad * factorTiempo;
        });

        probabilidad = (listaSi.length * 10) + proyeccionPendientes;
        const cap = 98;
        probabilidad = Math.min(probabilidad, cap);

        const decayStart = new Date(matchDate);
        decayStart.setDate(decayStart.getDate() - 1);
        decayStart.setHours(14, 0, 0, 0);
        const decayEnd = new Date(matchDate);
        let finalDecayActive = false;
        if (ahora > decayStart) {
            if (ahora < decayEnd) {
                probabilidad *= 1 - ((ahora - decayStart) / (decayEnd - decayStart));
                finalDecayActive = true;
            } else {
                probabilidad = 0;
            }
        }
        
        if (probabilidad >= 95) { claseColor = "ambar"; recomendacion = "¡Casi está! Solo falta confirmar."; }
        else if (probabilidad >= 70) { claseColor = "ambar"; recomendacion = "Por favor, confirmar lo antes posible."; }
        else if (probabilidad >= 40) { claseColor = "ambar"; recomendacion = "Por favor, confirmar lo antes posible."; }
        else { 
            claseColor = "rojo"; 
            overrideHtml = `<p class="probabilidad" style="font-size: 1.5em; line-height: 1.2;">Partido en Peligro</p>
                            <p class="recomendacion">🔥 La probabilidad es muy baja. Conviene buscar gente.</p>`;
        }

        if (finalDecayActive && !overrideHtml) {
            recomendacion += "<br><small>⚠️ ¡El tiempo se agota!</small>";
        }
    }
    
    if (probabilidad) probabilidad = Math.min(100, Math.max(0, probabilidad));

    const hayJugadorConBajas = listaSi.some(j => (j.bajas || 0) > 0);
    if(hayJugadorConBajas && recomendacion) {
        recomendacion += '<br><small style="font-weight: bold; opacity: 0.9;">AVISO: Hay apuntados con historial de bajas de última hora.</small>';
    }
    
    let isRefuerzosOpen = false;
    if (isAdmin) { isRefuerzosOpen = true; }
    else if (totalConfirmados >= 10) { isRefuerzosOpen = false; }
    else if (loggedInPlayer) {
        const ahora = getCurrentTime();
        let problematicMatches = 0;
        const last4MatchesKeys = Object.keys(historial || {}).sort().slice(-4);
        last4MatchesKeys.forEach(key => {
            if (historial[key].cancelado || historial[key].con_extras) {
                problematicMatches++;
            }
        });
        const hourOffset = problematicMatches * 6; 
        const activationTime = new Date(matchDate);
        activationTime.setDate(activationTime.getDate() - 1); 
        activationTime.setHours(14 - hourOffset, 0, 0, 0);
        if (showRefuerzosForce || ahora >= activationTime) {
            isRefuerzosOpen = true;
        }
    }

    document.getElementById('refuerzos-section').style.display = isRefuerzosOpen ? 'block' : 'none';
    if (isRefuerzosOpen && !showRefuerzosForce && !overrideHtml?.includes('amigos')) {
        recomendacion = (recomendacion || '') + '<br><small style="font-style: italic;">👥 Abierta la inscripción de amigos.</small>';
    }

    const siHtml = listaSi.map(j => `<li><span class="status-icon icon-si">✔</span> <span class="summary-player-name" data-key="${j.key}">${j.nombre}</span></li>`).join('');
    const refuerzosHtml = listaRefuerzos.map(([key, ref]) => {
        const puedeBorrar = isAdmin || (loggedInPlayer && loggedInPlayer.nombre === ref.anadidoPor);
        const delBtn = puedeBorrar ? `<span class="delete-refuerzo" data-key="${key}" data-owner="${ref.anadidoPor}">🗑️</span>` : '';
        return `<li><span class="status-icon icon-si">✔</span> <i>${ref.nombre} (Amigo de ${ref.anadidoPor})</i> ${delBtn}</li>`;
    }).join('');
    const pendienteHtml = listaPendiente.map(j => `<li><span class="status-icon icon-pendiente">?</span> <span class="summary-player-name" data-key="${j.key}">${j.nombre}</span></li>`).join('');
    const noHtml = listaNo.map(j => `<li><span class="status-icon icon-no">✖</span> <span class="summary-player-name" data-key="${j.key}">${j.nombre}</span></li>`).join('');

    const resultadoDiv = document.getElementById('resultado');
    resultadoDiv.className = 'resultado ' + claseColor;
    const listaHtml = `<div class="resumen"><strong>Respuestas (${totalConfirmados} confirmados):</strong><ul class="lista-apuntados">${siHtml}${refuerzosHtml}${pendienteHtml}${noHtml}</ul></div>`;
    
    const infoIconSvg = `<svg class="info-icon-svg" id="prob-info-icon" viewBox="0 0 16 16"><path d="M7.93,1.602c3.43,0,6.219,2.789,6.219,6.219c0,3.43-2.789,6.219-6.219,6.219c-3.43,0-6.219-2.789-6.219-6.219C1.711,4.391,4.5,1.602,7.93,1.602 M7.93,0C3.551,0,0,3.551,0,7.93c0,4.379,3.551,7.93,7.93,7.93s7.93-3.551,7.93-7.93C15.86,3.551,12.309,0,7.93,0z M8.578,11.969h-1.32V6.883h1.32V11.969z M7.91,5.559c-0.496,0-0.898-0.402-0.898-0.898c0-0.496,0.402-0.898,0.898-0.898s0.898,0.402,0.898,0.898C8.808,5.156,8.406,5.559,7.91,5.559z"/></svg>`;

    if (overrideHtml) {
        resultadoDiv.innerHTML = overrideHtml + listaHtml;
    } else {
        resultadoDiv.innerHTML = `<p class="probabilidad">${probabilidad.toFixed(0)}% <span style="font-size: 0.4em; opacity: 0.8; font-weight: 400;">probabilidad de jugar ${infoIconSvg}</span></p><p class="recomendacion">${recomendacion}</p>` + listaHtml;
    }
}

function renderTable() {
    const tablaBody = document.querySelector("#tabla-jugadores tbody");
    tablaBody.innerHTML = '';
    
    const jugadores = currentDbData.jugadores || {};
    const history = currentDbData.historial || {};
    const last4Matches = Object.keys(history).sort().slice(-4);

    Object.keys(jugadores).forEach(key => {
        const jugador = jugadores[key];
        
        let attended = 0;
        last4Matches.forEach(matchKey => {
            if (history[matchKey].jugadores?.[key]?.status === 'si') attended++;
        });
        const fiabilidad = last4Matches.length > 0 ? `${(attended / last4Matches.length * 100).toFixed(0)}%` : 'N/A';
        
        const status = jugador.status || 'pendiente';
        const fila = `
            <tr data-key="${key}">
                <td>${jugador.nombre}</td>
                <td><div class="status-radio">
                    <label><input type="radio" name="status-${key}" value="si" ${status === 'si' ? 'checked' : ''}> Sí</label>
                    <label><input type="radio" name="status-${key}" value="no" ${status === 'no' ? 'checked' : ''}> No</label>
                    <label><input type="radio" name="status-${key}" value="pendiente" ${status === 'pendiente' ? 'checked' : ''}> Pendiente</label>
                </div></td>
                <td class="admin-only"><input type="number" class="bajas" value="${jugador.bajas || 0}" min="0"></td>
                <td class="fiabilidad">${fiabilidad}</td>
                <td class="admin-only"><button class="delete-player-btn" title="Eliminar a ${jugador.nombre}">🗑️</button></td>
            </tr>`;
        tablaBody.innerHTML += fila;
    });
}

function applyVisibility() {
    const testSection = document.getElementById('admin-test-section');
    testSection.style.display = (isAdmin || loggedInPlayer) ? 'block' : 'none';
    if(isAdmin || loggedInPlayer) {
        const timeDisplay = document.getElementById('current-time-display');
        const now = getCurrentTime();
        timeDisplay.textContent = `Hora del sistema: ${now.toLocaleString('es-ES', { dateStyle: 'full', timeStyle: 'short' })} ${simulatedTime ? '(SIMULADA)' : ''}`;
    }
    
    document.getElementById('archive-button').style.display = (isAdmin && isMatchPendingActivation) ? 'block' : 'none';
    
    const tablaVisible = (isAdmin || loggedInPlayer) && !isMatchPendingActivation;
    document.getElementById('tabla-jugadores').style.display = tablaVisible ? '' : 'none';
    
    document.body.classList.toggle('admin-view', isAdmin);
    
    // --- MODIFICADO: Visibilidad del botón de WhatsApp ---
    document.getElementById('whatsapp-button').style.display = (isAdmin || loggedInPlayer) ? 'flex' : 'none';

    document.querySelectorAll('#tabla-jugadores tbody tr').forEach(fila => {
        const key = fila.dataset.key;
        const isPlayerRow = loggedInPlayer && loggedInPlayer.key === key;
        if (loggedInPlayer && !isAdmin) {
            fila.style.display = isPlayerRow ? '' : 'none';
        } else {
            fila.style.display = '';
        }
        fila.querySelectorAll('input, button').forEach(element => {
             element.disabled = !(isAdmin || isPlayerRow);
        });
    });
}

function getNextWednesday(forceNextWeek = false) {
    const d = new Date();
    const today = d.getDay();
    let offset = (3 - today + 7) % 7;
    if (forceNextWeek || (offset === 0 && d.getHours() >= 22)) {
        offset += 7;
    }
    const newDate = new Date(d);
    newDate.setDate(d.getDate() + offset);
    newDate.setHours(21, 0, 0, 0);
    return newDate;
}
</script>
</body>
</html>
