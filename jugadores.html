<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Partido de Fútbol</title>
    <style>
        /* Estilos generales del cuerpo y contenedor principal */
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:#f4f7f6;color:#333;margin:0;padding:10px}
        .container{max-width:800px;margin:auto;background-color:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.1)}
        
        /* Estilos para títulos y encabezados */
        h1,h2{text-align:center;color:#1a73e8}
        h1{font-size:1.8em;display:flex;align-items:center;justify-content:center;gap:15px}
        h2{border-bottom:2px solid #1a73e8;padding-bottom:10px;margin-top:30px}
        
        /* Estilos para la tabla de jugadores */
        table{width:100%;border-collapse:collapse;margin-top:20px}
        th,td{padding:12px;text-align:left;border-bottom:1px solid #ddd}
        th{background-color:#f2f2f2}
        .player-name{cursor:pointer; font-weight: bold;}
        .player-name:hover{color:#1a73e8;}
        
        /* Estilos para campos de entrada */
        input[type=number]{width:60px;padding:5px;border:1px solid #ccc;border-radius:4px;text-align:center}
        input[type=text]{padding:8px;border:1px solid #ccc;border-radius:4px;width:60%}
        
        /* Estilos para los botones de estado (Sí/No/Pendiente) */
        .status-radio{display:flex;gap:10px;justify-content:flex-start}
        
        /* Estilos del cuadro de resumen de probabilidad */
        .resultado, #pending-activation{padding:20px;margin-top:10px;border-radius:8px;text-align:center;color:#fff;transition:background-color .3s ease}
        .probabilidad{font-size:2.5em;font-weight:700;margin:0}
        .recomendacion{font-size:1.1em;font-weight:400;margin-top:10px}
        .resumen,.lista-apuntados{font-size:.9em;font-weight:400;margin-top:15px;opacity:.9;border-top:1px solid rgba(255,255,255,.3);padding-top:10px}
        .lista-apuntados{text-align:left;list-style:none;padding-left:0;}
        .lista-apuntados li{display:flex;align-items:center;padding:3px 0;}
        
        /* --- MEJORADO: Estilos para el icono de información SVG --- */
        .info-icon-svg { 
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px; /* Más espacio */
            cursor: pointer;
            opacity: 0.9; /* Más opaco por defecto */
            transition: opacity 0.2s ease-in-out;
            fill: #fff; /* Relleno blanco para contraste */
            stroke: #333; /* Borde oscuro para visibilidad */
            stroke-width: 1px; /* Grosor del borde */
            height: 18px; /* Un poco más grande */
            width: 18px; /* Un poco más grande */
        }
        .info-icon-svg:hover { opacity: 1; fill: #eee; stroke: #000; } /* Efecto hover más pronunciado */
        
        /* Icono para borrar refuerzos y jugadores */
        .delete-refuerzo, .delete-player-btn{cursor:pointer;font-size:1.1em;opacity:0.7;}
        .delete-refuerzo{margin-left:auto;}
        .delete-refuerzo:hover, .delete-player-btn:hover{opacity:1;}
        .delete-player-btn {background:none; border:none; padding:0 5px; font-size:1.2em;}
        
        /* Colores del cuadro de resumen */
        .verde{background-color:#28a745}
        .ambar{background:linear-gradient(45deg,#ffc107,#ff9800);color:#333}
        .rojo{background:linear-gradient(45deg,#dc3545,#b71c1c)}
        #pending-activation{background-color: #6c757d;}
        
        /* Clases para controlar la visibilidad del admin */
        .admin-only{display:none}
        .admin-view .admin-only{display:table-cell !important;}
        .admin-view .admin-button{display:block !important;}
        .admin-view #add-player-section, .admin-view #global-stats-section{display:block !important;}

        /* Iconos de login y candado */
        #admin-lock, #player-login{cursor:pointer;font-size:1.5em}
        #login-info{font-size:0.8em;color:#333;text-align:center;margin-top:10px}
        
        /* Secciones de admin */
        #refuerzos-section, #add-player-section, #global-stats-section{margin-top:25px;padding:15px;border:1px solid #eee;border-radius:8px;display:none}
        
        /* Estilos para iconos de estado */
        .status-icon{display:inline-flex;justify-content:center;align-items:center;width:1.4em;height:1.4em;border-radius:50%;color:#fff;font-weight:700;margin-right:8px;border:2px solid black;font-size:.9em; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);}
        .icon-si{background-color:#28a745}
        .icon-pendiente{background-color:#ffc107;color:#333}
        .icon-no{background-color:#dc3545}
        
        /* Modo Test */
        #admin-test-section button{padding:5px 10px;margin-left:5px;}

        /* Estilos para móviles */
        @media screen and (max-width:600px){
            body{padding:5px}.container{padding:15px}h1{font-size:1.5em}.probabilidad{font-size:2em}.recomendacion{font-size:1em}
            table,thead,tbody,th,td,tr{display:block}
            thead tr{position:absolute;top:-9999px;left:-9999px}
            tr{border:1px solid #ccc;margin-bottom:15px;border-radius:5px;padding:5px}
            td{border:none;border-bottom:1px solid #eee;position:relative;padding-left:50%;text-align:right}
            td:before{position:absolute;left:6px;width:45%;padding-right:10px;white-space:nowrap;text-align:left;font-weight:700}
            td:nth-of-type(1):before{content:"Nombre"}td:nth-of-type(2):before{content:"Estado"}td:nth-of-type(3):before{content:"Bajas"}td:nth-of-type(4):before{content:"Fiabilidad"}td:nth-of-type(5):before{content:"Acción"}
            .status-radio{justify-content:flex-end}input[type=number]{width:70px}
            .admin-view .admin-only{display:block !important;}
        }
    </style>
</head>
<body>

<div class="container">
    <h1><span id="admin-lock">🔓</span> Gestor de Partido <span id="player-login">👤</span></h1>
    <div id="login-info">Identifícate para responder</div>
    <h2 id="match-date-title">Cargando...</h2>

    <div id="main-content" style="display: none;">
        <div id="pending-activation" style="display: none;">
            <h3>Partido pendiente de activarse</h3>
            <p>Vuelva a conectarse en unas horas.</p>
        </div>
        
        <button id="archive-button" class="admin-only admin-button" style="display:none; width: 100%; padding: 10px; margin-bottom: 15px; background-color: #1a73e8; color: white; border: none; border-radius: 5px; cursor: pointer;">Archivar y Activar Siguiente Partido</button>
        
        <div id="resultado"></div>
        
        <div id="refuerzos-section">
            <h4>Añadir Refuerzos</h4>
            <input type="text" id="refuerzo-nombre" placeholder="Nombre del refuerzo...">
            <button id="add-refuerzo-btn">Añadir</button>
        </div>
        
        <table id="tabla-jugadores">
            <thead><tr><th>Nombre</th><th>Estado</th><th class="admin-only">Bajas</th><th>Fiabilidad</th><th class="admin-only">Acción</th></tr></thead>
            <tbody></tbody>
        </table>

        <div id="add-player-section" class="admin-only">
            <h4>Añadir Nuevo Jugador a la Plantilla</h4>
            <input type="text" id="new-player-name" placeholder="Nombre del nuevo jugador...">
            <button id="add-player-btn">Añadir</button>
        </div>

        <div id="admin-test-section" style="display: none; margin-top: 20px; padding: 15px; border: 2px dashed #ccc; border-radius: 8px;">
            <h4 style="margin-top:0;">Modo Test</h4>
            <label for="test-date">Simular Fecha y Hora:</label>
            <input type="datetime-local" id="test-date">
            <button id="apply-test-date">Aplicar</button>
            <button id="reset-test-date">Hora Real</button>
            <p id="current-time-display" style="font-size: 0.9em; color: #555; margin-top: 10px;"></p>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
// --- CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE ---
const firebaseConfig = {
  apiKey: "TU_API_KEY", // ¡IMPORTANTE! Reemplaza con tu propia API Key
  authDomain: "TU_AUTH_DOMAIN", // Reemplaza
  databaseURL: "TU_DATABASE_URL", // Reemplaza
  projectId: "TU_PROJECT_ID", // Reemplaza
  storageBucket: "TU_STORAGE_BUCKET", // Reemplaza
  messagingSenderId: "TU_MESSAGING_SENDER_ID", // Reemplaza
  appId: "TU_APP_ID" // Reemplaza
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// --- VARIABLES GLOBALES DE ESTADO ---
let adminPassword = "";
let isAdmin = false;
let loggedInPlayer = null;
let currentDbData = null;
let simulatedTime = null; 
let isMatchPendingActivation = false;

// --- LÓGICA DE LOGIN ---
database.ref('config/password').once('value', (snapshot) => { adminPassword = snapshot.val(); });

document.getElementById('admin-lock').addEventListener('click', () => {
    if (isAdmin) {
        isAdmin = false;
        loggedInPlayer = null;
        document.getElementById('login-info').textContent = 'Identifícate para responder';
    } else {
        const pass = prompt('Introduce la contraseña de administrador:');
        if (pass === adminPassword) {
            isAdmin = true;
            loggedInPlayer = null;
            document.getElementById('login-info').textContent = 'Sesión iniciada como Administrador';
        } else if (pass) { alert('Contraseña incorrecta.'); }
    }
    renderUI();
});

document.getElementById('player-login').addEventListener('click', () => {
    if (!currentDbData || !currentDbData.jugadores) return;
    const accessCode = prompt('Introduce tu código de acceso:');
    if (!accessCode) return;
    
    const jugadores = currentDbData.jugadores;
    const playerKey = Object.keys(jugadores).find(key => jugadores[key].password === accessCode);

    if (playerKey) {
        loggedInPlayer = {...jugadores[playerKey], key: playerKey};
        isAdmin = false;
        document.getElementById('login-info').textContent = `Sesión iniciada como: ${loggedInPlayer.nombre}`;
    } else {
        alert('Código de acceso no reconocido.');
    }
    renderUI();
});


// --- LÓGICA PRINCIPAL Y EVENTOS ---
document.addEventListener('DOMContentLoaded', function() {
    // Listener principal de Firebase
    database.ref().on('value', (snapshot) => {
        const data = snapshot.val();
        if (data && data.jugadores) {
            currentDbData = data;
            
            const ahora = getCurrentTime();
            const nextMatchDate = (currentDbData.matchInfo && currentDbData.matchInfo.nextMatchDate) ? new Date(currentDbData.matchInfo.nextMatchDate) : getNextWednesday();
            
            const activationTimeLimit = new Date(nextMatchDate);
            activationTimeLimit.setHours(22, 0, 0, 0); 
            
            isMatchPendingActivation = ahora > activationTimeLimit;
            renderUI();
        }
    });

    // Delegación de eventos para la tabla
    document.getElementById('tabla-jugadores').addEventListener('click', (e) => {
        const fila = e.target.closest('tr');
        if (!fila) return;
        
        const playerKey = fila.dataset.key;
        if (!playerKey) return;

        if (e.target.classList.contains('delete-player-btn')) {
            const jugador = currentDbData.jugadores[playerKey];
            if (confirm(`¿Seguro que quieres eliminar a ${jugador.nombre} de la plantilla?\nEsta acción es permanente.`)) {
                database.ref('jugadores/' + playerKey).remove()
                    .then(() => alert(`${jugador.nombre} ha sido eliminado.`))
                    .catch(error => alert("Error al eliminar: " + error.message));
            }
        }
        // --- CORREGIDO: Ahora funciona el click en el nombre del jugador ---
        else if (e.target.classList.contains('player-name')) {
            const history = currentDbData.historial || {};
            const last4Matches = Object.keys(history).sort().slice(-4);
            let attended = 0;
            last4Matches.forEach(matchKey => {
                const matchData = history[matchKey];
                // Asegurarse de que el matchData y el jugador existan y tengan un status 'si'
                if (matchData.jugadores && matchData.jugadores[playerKey] && matchData.jugadores[playerKey].status === 'si') {
                    attended++;
                }
            });
            const reliabilityPercentage = last4Matches.length > 0 ? (attended / last4Matches.length * 100).toFixed(0) : 0;
            alert(`Fiabilidad de ${currentDbData.jugadores[playerKey].nombre} (últimos ${last4Matches.length} partidos):\n\nAsistencias: ${attended} de ${last4Matches.length}\nPorcentaje: ${reliabilityPercentage}%`);
        }
    });
    
    document.getElementById('tabla-jugadores').addEventListener('change', (e) => {
        const fila = e.target.closest('tr');
        if (!fila) return;
        const playerKey = fila.dataset.key;
        const target = e.target;

        if (target.classList.contains('bajas')) {
            database.ref(`jugadores/${playerKey}/bajas`).set(parseInt(target.value, 10));
        } else if (target.name.startsWith('status-')) {
             database.ref(`jugadores/${playerKey}/status`).set(target.value);
        }
    });

    // Listeners del Modo Test
    document.getElementById('apply-test-date').addEventListener('click', () => {
        const dateValue = document.getElementById('test-date').value;
        simulatedTime = dateValue ? new Date(dateValue) : null;
        const ahora = getCurrentTime();
        const nextMatchDate = (currentDbData.matchInfo && currentDbData.matchInfo.nextMatchDate) ? new Date(currentDbData.matchInfo.nextMatchDate) : getNextWednesday();
        const activationTimeLimit = new Date(nextMatchDate);
        activationTimeLimit.setHours(22, 0, 0, 0); 
        isMatchPendingActivation = (ahora > activationTimeLimit);
        renderUI();
    });
    document.getElementById('reset-test-date').addEventListener('click', () => {
        simulatedTime = null;
        document.getElementById('test-date').value = '';
        const ahora = getCurrentTime();
        const nextMatchDate = (currentDbData.matchInfo && currentDbData.matchInfo.nextMatchDate) ? new Date(currentDbData.matchInfo.nextMatchDate) : getNextWednesday();
        const activationTimeLimit = new Date(nextMatchDate);
        activationTimeLimit.setHours(22, 0, 0, 0); 
        isMatchPendingActivation = (ahora > activationTimeLimit);
        renderUI();
    });

    document.getElementById('archive-button').addEventListener('click', async () => {
        if (!isAdmin || !isMatchPendingActivation) return;
        if (!confirm('¿Estás seguro de que quieres archivar este partido y activar el siguiente?')) return;

        const { jugadores, refuerzos, matchInfo } = currentDbData;
        const oldMatchDate = (matchInfo && matchInfo.nextMatchDate) ? new Date(matchInfo.nextMatchDate) : getNextWednesday();
        // Usamos un formato de clave simple y válido para Firebase
        const matchKey = oldMatchDate.toISOString().replace(/\..+/, '').replace(/[:T]/g, '-');

        const listaSi = Object.values(jugadores).filter(j => j.status === 'si');
        const listaRefuerzos = refuerzos ? Object.values(refuerzos) : [];
        const totalConfirmados = listaSi.length + listaRefuerzos.length;

        // Preparamos los datos del historial con la estructura simplificada
        const historialJugadores = {};
        Object.keys(jugadores).forEach(key => {
            historialJugadores[key] = {
                nombre: jugadores[key].nombre,
                status: jugadores[key].status
            };
        });

        const archiveData = {
            jugadores: historialJugadores,
            refuerzos: refuerzos || null,
            cancelado: totalConfirmados < 10,
            con_extras: totalConfirmados >= 10 && listaSi.length < 10,
        };
        
        const updates = {};
        updates[`/historial/${matchKey}`] = archiveData;
        
        Object.keys(jugadores).forEach(key => {
            updates[`/jugadores/${key}/status`] = 'pendiente';
        });

        updates['/refuerzos'] = null;
        updates['/matchInfo/nextMatchDate'] = getNextWednesday(true).toISOString();

        try {
            await database.ref().update(updates);
            alert('Partido archivado y nuevo partido activado correctamente.');
        } catch (error) {
            alert('Error al archivar el partido: ' + error.message);
        }
    });

    document.getElementById('add-refuerzo-btn').addEventListener('click', () => {
        const nombreRefuerzo = document.getElementById('refuerzo-nombre').value.trim();
        if(nombreRefuerzo && (isAdmin || loggedInPlayer)) {
            const anadidoPor = isAdmin ? 'Admin' : loggedInPlayer.nombre;
            database.ref('refuerzos').push({ nombre: nombreRefuerzo, anadidoPor });
            document.getElementById('refuerzo-nombre').value = '';
        } else {
            alert("Debes identificarte para añadir un refuerzo.");
        }
    });
    
    document.getElementById('add-player-btn').addEventListener('click', () => {
        const newName = document.getElementById('new-player-name').value.trim();
        if (!newName) { return alert("Por favor, introduce un nombre."); }
        const newPassword = prompt(`Introduce la contraseña para ${newName}:`);
        if (!newPassword) { return alert("La contraseña no puede estar vacía."); }
        const newPlayer = { nombre: newName, password: newPassword, status: "pendiente", bajas: 0 };
        
        database.ref('jugadores').push(newPlayer)
            .then(() => {
                alert(`${newName} ha sido añadido a la plantilla.`);
                document.getElementById('new-player-name').value = '';
            })
            .catch(error => alert("Error al añadir jugador: " + error.message));
    });
    
    // Listener principal del contenedor para borrar refuerzos y para el icono de info
    document.querySelector('.container').addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-refuerzo')) {
            const refKey = e.target.dataset.key;
            const refOwner = e.target.dataset.owner;
            if (isAdmin || (loggedInPlayer && loggedInPlayer.nombre === refOwner)) {
                if (refKey && confirm('¿Quitar a este refuerzo de la lista?')) {
                    database.ref('refuerzos/' + refKey).remove();
                }
            } else {
                alert('Solo el admin o la persona que añadió el refuerzo puede borrarlo.');
            }
        }
        // --- MEJORADO: Listener para el icono de información ---
        if (e.target.closest('#prob-info-icon')) {
            alert('Probabilidad basada en los datos históricos de los últimos cuatro partidos.');
        }
    });
});


// --- FUNCIONES DE RENDERIZADO Y CÁLCULO ---
function getCurrentTime() { return simulatedTime ? new Date(simulatedTime) : new Date(); }

function renderUI() {
    if (!currentDbData) return;
    document.getElementById('main-content').style.display = 'block';

    if (isMatchPendingActivation && !isAdmin) {
        document.getElementById('pending-activation').style.display = 'block';
        document.getElementById('resultado').style.display = 'none';
        document.getElementById('tabla-jugadores').style.display = 'none';
        document.getElementById('refuerzos-section').style.display = 'none';
    } else {
        document.getElementById('pending-activation').style.display = 'none';
        document.getElementById('resultado').style.display = 'block';
        renderSummary();
        renderTable();
    }
    applyVisibility();
}

function renderSummary() {
    const { jugadores, refuerzos, matchInfo, historial } = currentDbData;
    const matchDate = (matchInfo && matchInfo.nextMatchDate) ? new Date(matchInfo.nextMatchDate) : getNextWednesday();
    document.getElementById('match-date-title').textContent = `Partido del ${matchDate.toLocaleDateString('es-ES', { weekday: 'long', month: 'long', day: 'numeric' })}`;

    const JUGADORES_NECESARIOS = 10;
    const listaSi = [], listaPendiente = [], listaNo = [];
    
    const jugadoresObj = jugadores || {};
    Object.keys(jugadoresObj).forEach(key => {
        const j = {...jugadoresObj[key], key: key};
        if (j.status === 'si') listaSi.push(j);
        else if (j.status === 'no') listaNo.push(j);
        else listaPendiente.push(j);
    });

    const listaRefuerzos = refuerzos ? Object.entries(refuerzos) : [];
    
    let probabilidad, recomendacion, claseColor, overrideHtml = null;
    let showRefuerzosForce = false;
    const totalConfirmados = listaSi.length + listaRefuerzos.length;
    const maximoPosiblePlantilla = listaSi.length + listaPendiente.length;

    if (totalConfirmados >= JUGADORES_NECESARIOS) {
        claseColor = "verde";
        recomendacion = `Ya sois ${totalConfirmados}.`;
        overrideHtml = `<p class="probabilidad" style="font-size: 1.8em; line-height: 1.2;">Partido Confirmado</p>`;
    } else if (maximoPosiblePlantilla < JUGADORES_NECESARIOS) {
        claseColor = "rojo";
        const faltan = JUGADORES_NECESARIOS - totalConfirmados;
        overrideHtml = `<p class="probabilidad" style="font-size: 1.5em; line-height: 1.2;">Partido en riesgo</p>
                        <p class="recomendacion">Imposible llegar a 10 con la plantilla. Se necesitan ${faltan} refuerzo(s).</p>`;
        showRefuerzosForce = true;
    } else {
        const ahora = getCurrentTime();
        let proyeccionPendientes = 0;
        
        const last4MatchesKeys = Object.keys(historial || {}).sort().slice(-4);

        listaPendiente.forEach(jugador => {
            let attended = 0;
            last4MatchesKeys.forEach(matchKey => {
                const matchData = historial[matchKey];
                if (matchData.jugadores && matchData.jugadores[jugador.key] && matchData.jugadores[jugador.key].status === 'si') {
                    attended++;
                }
            });
            const fiabilidadReal = last4MatchesKeys.length > 0 ? (attended / last4MatchesKeys.length) : 0;
            
            const pisoFiabilidad = 0.1; // Puedes ajustar este valor si lo deseas
            const fiabilidad = Math.max(fiabilidadReal, pisoFiabilidad);

            const mondayStart = new Date(matchDate);
            mondayStart.setDate(mondayStart.getDate() - 2);
            mondayStart.setHours(0, 0, 0, 0);
            const tuesdayEnd = new Date(mondayStart);
            tuesdayEnd.setDate(tuesdayEnd.getDate() + 1);
            tuesdayEnd.setHours(14, 0, 0, 0);
            let factorTiempo = 1.0;
            if (ahora > mondayStart) {
                if (ahora < tuesdayEnd) factorTiempo = 1.0 - ((ahora - mondayStart) / (tuesdayEnd - mondayStart) * (1.0 - 0.33));
                else factorTiempo = 0.33;
            }
            proyeccionPendientes += 10 * fiabilidad * factorTiempo;
        });
        
        probabilidad = (totalConfirmados * 10) + proyeccionPendientes;
        
        const cap = 98; // Tope de probabilidad antes de la confirmación
        probabilidad = Math.min(probabilidad, cap);

        const decayStart = new Date(matchDate);
        decayStart.setDate(decayStart.getDate() - 1);
        decayStart.setHours(14, 0, 0, 0);
        const decayEnd = new Date(matchDate);
        let finalDecayActive = false;
        if (ahora > decayStart) {
            if (ahora < decayEnd) {
                probabilidad *= 1 - ((ahora - decayStart) / (decayEnd - decayStart));
                finalDecayActive = true;
            } else {
                probabilidad = 0;
            }
        }
        
        if (probabilidad >= 95) { claseColor = "verde"; recomendacion = ""; }
        else if (probabilidad >= 70) { claseColor = "ambar"; recomendacion = "Por favor, confirmar lo antes posible."; }
        else if (probabilidad >= 40) { claseColor = "ambar"; recomendacion = "Por favor, confirmar lo antes posible."; }
        else { claseColor = "rojo"; recomendacion = "🔥 El partido peligra."; }

        if (finalDecayActive) {
            recomendacion += "<br><small>⚠️ ¡El tiempo se agota! La probabilidad disminuye cada hora.</small>";
        }
    }
    
    if (probabilidad) probabilidad = Math.min(100, Math.max(0, probabilidad));

    const hayJugadorConBajas = listaSi.some(j => (j.bajas || 0) > 0);
    if(hayJugadorConBajas) {
        recomendacion = (overrideHtml ? '' : recomendacion) + '<br><small style="font-weight: bold; opacity: 0.9;">AVISO: Hay apuntados con historial de bajas de última hora.</small>';
    }
    
    let isRefuerzosOpen = false;
    if (isAdmin) { isRefuerzosOpen = true; }
    else if (totalConfirmados >= 10) { isRefuerzosOpen = false; }
    else if (loggedInPlayer) {
        const ahora = getCurrentTime();
        
        let problematicMatches = 0;
        const last4MatchesKeys = Object.keys(historial || {}).sort().slice(-4);
        last4MatchesKeys.forEach(key => {
            const match = historial[key];
            if (match.cancelado || match.con_extras) {
                problematicMatches++;
            }
        });
        const hourOffset = problematicMatches * 6; 

        const activationTime = new Date(matchDate);
        activationTime.setDate(activationTime.getDate() - 1); 
        activationTime.setHours(14 - hourOffset, 0, 0, 0);

        if (showRefuerzosForce || ahora >= activationTime) {
            isRefuerzosOpen = true;
        }
    }

    document.getElementById('refuerzos-section').style.display = isRefuerzosOpen ? 'block' : 'none';
    if (isRefuerzosOpen && !showRefuerzosForce) {
        recomendacion += '<br><small style="font-style: italic;">👥 Ya está abierta la inscripción de amigos.</small>';
    }

    const siHtml = listaSi.map(j => `<li><span class="status-icon icon-si">✔</span> ${j.nombre}</li>`).join('');
    const refuerzosHtml = listaRefuerzos.map(([key, ref]) => {
        const puedeBorrar = isAdmin || (loggedInPlayer && loggedInPlayer.nombre === ref.anadidoPor);
        const delBtn = puedeBorrar ? `<span class="delete-refuerzo" data-key="${key}" data-owner="${ref.anadidoPor}">🗑️</span>` : '';
        return `<li><span class="status-icon icon-si">✔</span> <i>${ref.nombre} (Amigo de ${ref.anadidoPor})</i> ${delBtn}</li>`;
    }).join('');
    const pendienteHtml = listaPendiente.map(j => `<li><span class="status-icon icon-pendiente">?</span> ${j.nombre}</li>`).join('');
    const noHtml = listaNo.map(j => `<li><span class="status-icon icon-no">✖</span> ${j.nombre}</li>`).join('');

    const resultadoDiv = document.getElementById('resultado');
    resultadoDiv.className = 'resultado ' + claseColor;
    const listaHtml = `<div class="resumen"><strong>Respuestas (${totalConfirmados} confirmados):</strong><ul class="lista-apuntados">${siHtml}${refuerzosHtml}${pendienteHtml}${noHtml}</ul></div>`;
    
    // --- MEJORADO: Icono SVG y movido al final ---
    const infoIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" stroke="currentColor" stroke-width="1.2"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.082.082-.38-.45-.083a.294.294 0 0 1-.288-.469l.738-3.468c.064-.293-.006-.399-.287-.47L8 8.411v.002zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>`;

    if (overrideHtml) {
        resultadoDiv.innerHTML = overrideHtml + listaHtml;
    } else {
        resultadoDiv.innerHTML = `<p class="probabilidad">${probabilidad.toFixed(0)}% <span style="font-size: 0.4em; opacity: 0.8; font-weight: 400;">probabilidad de jugar <span id="prob-info-icon" class="info-icon-svg" title="Más información">${infoIconSvg}</span></span></p><p class="recomendacion">${recomendacion}</p>` + listaHtml;
    }
}

function renderTable() {
    const tablaBody = document.querySelector("#tabla-jugadores tbody");
    tablaBody.innerHTML = '';
    
    const jugadores = currentDbData.jugadores || {};
    const history = currentDbData.historial || {};
    const last4Matches = Object.keys(history).sort().slice(-4);

    Object.keys(jugadores).forEach(key => {
        const jugador = jugadores[key];
        
        let attended = 0;
        last4Matches.forEach(matchKey => {
            const matchData = history[matchKey];
            if (matchData.jugadores && matchData.jugadores[key] && matchData.jugadores[key].status === 'si') {
                attended++;
            }
        });

        const fiabilidad = last4Matches.length > 0 ? `${(attended / last4Matches.length * 100).toFixed(0)}%` : 'N/A';
        const status = jugador.status || 'pendiente';
        
        const fila = `
            <tr data-key="${key}">
                <td><span class="player-name">${jugador.nombre}</span></td>
                <td><div class="status-radio">
                    <label><input type="radio" name="status-${key}" value="si" ${status === 'si' ? 'checked' : ''}> Sí</label>
                    <label><input type="radio" name="status-${key}" value="no" ${status === 'no' ? 'checked' : ''}> No</label>
                    <label><input type="radio" name="status-${key}" value="pendiente" ${status === 'pendiente' ? 'checked' : ''}> Pendiente</label>
                </div></td>
                <td class="admin-only"><input type="number" class="bajas" value="${jugador.bajas || 0}" min="0"></td>
                <td class="fiabilidad">${fiabilidad}</td>
                <td class="admin-only"><button class="delete-player-btn" title="Eliminar a ${jugador.nombre}">🗑️</button></td>
            </tr>`;
        tablaBody.innerHTML += fila;
    });
}

function applyVisibility() {
    const testSection = document.getElementById('admin-test-section');
    testSection.style.display = (isAdmin || loggedInPlayer) ? 'block' : 'none';
    if(isAdmin || loggedInPlayer) {
        const timeDisplay = document.getElementById('current-time-display');
        const now = getCurrentTime();
        timeDisplay.textContent = `Hora del sistema: ${now.toLocaleString('es-ES', { dateStyle: 'full', timeStyle: 'short' })} ${simulatedTime ? '(SIMULADA)' : ''}`;
    }
    
    document.getElementById('archive-button').style.display = (isAdmin && isMatchPendingActivation) ? 'block' : 'none';
    
    const tablaVisible = (isAdmin || loggedInPlayer) && !isMatchPendingActivation;
    document.getElementById('tabla-jugadores').style.display = tablaVisible ? '' : 'none';
    
    document.body.classList.toggle('admin-view', isAdmin);
    
    document.querySelectorAll('#tabla-jugadores tbody tr').forEach(fila => {
        const key = fila.dataset.key;
        const isPlayerRow = loggedInPlayer && loggedInPlayer.key === key;
        if (loggedInPlayer && !isAdmin) {
            fila.style.display = isPlayerRow ? '' : 'none';
        } else {
            fila.style.display = '';
        }
        fila.querySelectorAll('input, .delete-player-btn').forEach(element => { // También deshabilitar el botón de borrar para no-admins
             element.disabled = !(isAdmin || isPlayerRow);
             if (element.classList.contains('delete-player-btn') && !isAdmin) {
                 element.style.display = 'none'; // Ocultar si no es admin
             } else if (element.classList.contains('delete-player-btn') && isAdmin) {
                 element.style.display = ''; // Mostrar si es admin
             }
        });
    });
}

function getNextWednesday(forceNextWeek = false) {
    const d = new Date();
    const today = d.getDay(); // 0 = Domingo, 1 = Lunes, ..., 3 = Miércoles
    let offset = (3 - today + 7) % 7; // Días para el próximo miércoles (0 si es miércoles)

    // Si ya es miércoles y son las 22:00h o más tarde, o si forceNextWeek es true,
    // entonces el próximo partido es el miércoles de la semana siguiente.
    if (forceNextWeek || (offset === 0 && d.getHours() >= 22)) {
        offset = offset === 0 ? 7 : offset + 7; // Sumar 7 días para ir al miércoles de la semana siguiente
    }
    
    const newDate = new Date(d);
    newDate.setDate(d.getDate() + offset);
    newDate.setHours(21, 0, 0, 0); // Establecer la hora a las 21:00 (hora del partido)
    return newDate;
}
</script>
</body>
</html>
