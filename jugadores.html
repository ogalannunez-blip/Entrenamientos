<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Partido de F√∫tbol</title>
    <style>
        /* Estilos generales */
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:#f4f7f6;color:#333;margin:0;padding:10px}
        .container{max-width:800px;margin:auto;background-color:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 15px rgba(0,0,0,.1); padding-bottom: 80px;}
        
        /* Encabezados */
        h1,h2{text-align:center;color:#1a73e8}
        h1{font-size:1.8em;display:flex;align-items:center;justify-content:center;gap:15px}
        .date-header{display:flex;justify-content:center;align-items:center;gap:15px;}
        h2{border-bottom:2px solid #1a73e8;padding-bottom:10px;margin-top:30px; flex-grow: 1; line-height: 1.5;}
        
        /* Iconos y etiquetas de Login */
        .login-controls{display:flex;justify-content:center;gap:30px;align-items:flex-start;}
        .login-icon-wrapper{display:flex;flex-direction:column;align-items:center;cursor:pointer;}
        .login-label{font-size:0.7em;font-weight:600;color:#555;margin-top:2px;}
        
        /* Estilos para los iconos de informaci√≥n */
        .info-icon {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background-color: #1a73e8; /* Color de fondo azul s√≥lido */
            color: white; /* Color de la 'i' en blanco */
            border-radius: 50%;
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-weight: bold;
            font-size: 14px;
            margin-left: 8px;
            transition: background-color 0.3s ease;
            user-select: none; /* Evita que el texto 'i' se seleccione */
            vertical-align: middle; /* Alineaci√≥n vertical */
        }
        .info-icon:hover {
            background-color: #4285f4; /* Un azul un poco m√°s claro al pasar el rat√≥n */
        }

        /* Tabla de jugadores */
        table{width:100%;border-collapse:collapse;margin-top:20px}
        th,td{padding:12px;text-align:left;border-bottom:1px solid #ddd}
        th{background-color:#f2f2f2}
        .summary-player-name {cursor:pointer;text-decoration:underline;text-decoration-style:dotted;text-decoration-thickness:1px;}
        .summary-player-name:hover {color:#1a73e8;}
        
        /* Entradas y botones */
        input[type=number]{width:60px;padding:5px;border:1px solid #ccc;border-radius:4px;text-align:center}
        input[type=text]{padding:8px;border:1px solid #ccc;border-radius:4px;width:60%; height: 35px; box-sizing: border-box; vertical-align: middle;}
        #refuerzos-section button, #add-player-section button { height: 35px; box-sizing: border-box; vertical-align: middle; cursor: pointer;}
        .status-radio{display:flex;gap:10px;justify-content:flex-start}
        .admin-button{width:calc(100% - 20px);padding:10px;margin:0 10px 15px 10px;background-color:#6c757d;color:white;border:none;border-radius:5px;cursor:pointer;}
        .admin-button:hover{opacity:0.9;}

        /* Cuadro de resumen */
        .resultado, #pending-activation{padding:20px;margin-top:10px;border-radius:8px;text-align:center;color:#fff;transition:background-color .3s ease}
        .probabilidad{font-size:2.5em;font-weight:700;margin:0}
        .recomendacion{font-size:1.1em;font-weight:400;margin-top:10px}
        .resumen,.lista-apuntados{font-size:.9em;font-weight:400;margin-top:15px;opacity:.9;border-top:1px solid rgba(255,255,255,.3);padding-top:10px}
        .lista-apuntados{text-align:left;list-style:none;padding-left:0;}
        .lista-apuntados li{display:flex;align-items:center;padding:3px 0;}
        
        /* Bot√≥n de WhatsApp */
        #whatsapp-button{position:fixed;bottom:20px;right:20px;background-color:#25D366;color:white;border:none;border-radius:50%;width:50px;height:50px;display:none;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,.3);transition:transform .2s;z-index:100;}
        #whatsapp-button:hover{transform:scale(1.1);}
        #whatsapp-button svg{width:28px;height:28px;fill:white;}

        /* Iconos de acci√≥n */
        .delete-refuerzo, .delete-player-btn{cursor:pointer;font-size:1.1em;opacity:0.7;}
        .delete-refuerzo{margin-left:auto; text-shadow: 0 0 3px white, 0 0 5px white;} /* Mejora de visibilidad */
        .delete-refuerzo:hover, .delete-player-btn:hover{opacity:1;}
        .delete-player-btn {background:none; border:none; padding:0 5px; font-size:1.2em;}
        
        /* Colores del resumen */
        .verde{background-color:#28a745}
        .ambar{background:linear-gradient(45deg,#ffc107,#ff9800);color:#333}
        .rojo{background:linear-gradient(45deg,#dc3545,#b71c1c)}
        #pending-activation{background-color:#6c757d;}
        
        /* Visibilidad de Admin */
        .admin-only{display:none}
        .admin-view .admin-only{display:table-cell !important;}
        .admin-view .admin-button{display:block !important;}
        .admin-view #add-player-section{display:block !important;}

        /* Iconos de estado */
        #admin-lock, #player-login{cursor:pointer;font-size:1.5em}
        #login-info{font-size:0.8em;color:#333;text-align:center;margin-top:10px;}
        .highlight-login {background-color:#fffbdd;border:1px solid #ffeb3b;padding:5px 10px;border-radius:5px;display:inline-block;margin-top:5px; text-align:right;}
        
        /* Secciones de admin */
        #refuerzos-section, #add-player-section{margin-top:25px;padding:15px;border:1px solid #eee;border-radius:8px;display:none}
        .status-icon{display:inline-flex;justify-content:center;align-items:center;width:1.4em;height:1.4em;border-radius:50%;color:#fff;font-weight:700;margin-right:8px;border:2px solid black;font-size:.9em;text-shadow:1px 1px 2px rgba(0,0,0,.5);}
        .icon-si{background-color:#28a745}
        .icon-pendiente{background-color:#ffc107;color:#333}
        .icon-no{background-color:#dc3545}
        
        /* Modo Test */
        #admin-test-section button{padding:5px 10px;margin-left:5px;}

        /* Ventanas Modales */
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;justify-content:center;align-items:flex-start;padding-top:10vh;z-index:1000}
        .modal-box{background:#fff;padding:25px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.3);text-align:center;width:90%;max-width:400px;color:#333}
        .modal-title{font-size:1.4em;font-weight:600;margin-top:0;margin-bottom:15px;color:#1a73e8}
        .modal-message{font-size:1em;line-height:1.5;margin-bottom:25px;white-space:pre-wrap;text-align:center;}
        .modal-input{width:80%;padding:10px;margin-bottom:20px;border:1px solid #ccc;border-radius:5px;font-size:1em;}
        .modal-buttons{display:flex;justify-content:center;gap:15px;}
        .modal-button{padding:10px 20px;border:none;border-radius:5px;background-color:#1a73e8;color:white;font-size:1em;cursor:pointer}
        .modal-button.cancel{background-color:#6c757d;}
        .modal-button:hover{opacity:0.85;}
        
        /* Estilos para el widget del tiempo */
        #weather-forecast{font-size:0.9em;color:#555;text-align:center;padding:10px;border:1px solid #eee;border-radius:8px;margin-top:15px;display:flex;justify-content:center;align-items:center;gap:15px;}
        .weather-icon{font-size:1.5em;}
        
        /* --- ESTILOS MEJORAS --- */
        #equipment-summary {text-align: center;padding: 8px;margin-bottom: 15px;background-color: #e9ecef;border-radius: 6px;font-size: 0.9em;line-height: 1.5;}
        #equipment-summary span {margin: 0 10px;}
        .equipment-question {margin-bottom: 15px;text-align: left;padding-left: 20%;}
        .equipment-question p {margin-bottom: 5px;font-weight: 600;}
        .login-info-container {display:flex;align-items:center;justify-content:center;gap:10px; position: relative;}
        #match-menu-icon {cursor:pointer;font-size:1.5em;position:relative;display:none;}
        #match-menu-icon.active {display:inline-block;}
        .notification-dot {width:8px;height:8px;background-color:red;border-radius:50%;position:absolute;top:0;right:0;display:none;}
        #match-menu-dropdown {display:none;position:absolute;background-color:#fff;box-shadow:0 8px 16px rgba(0,0,0,0.2);z-index:1001;border-radius:5px; left: 5px; top: 30px; width: 100px; text-align: left;}
        
        #match-menu-dropdown .menu-option { padding: 8px 12px; cursor: pointer; font-size: 0.8em !important; }
        .menu-option:hover { background-color:#f1f1f1; }
        #match-menu-dropdown .notification-dot-text { font-size: 0.5em !important; vertical-align: middle; color:red; display:none; margin-right: 4px;}

        .team-modal-container {display:flex;justify-content:space-around;text-align:center;}
        .team-column h4 {font-size:1.2em;color:#333;border-bottom:2px solid;padding-bottom:5px;}
        .team-column ul {list-style:none;padding:0;}
        .team-column li {padding:4px 0;}
        .team-verde h4 {border-color:#28a745;}
        .team-naranja h4 {border-color:#ff9800;}
        .team-switch-btn { cursor:pointer; font-weight: bold; padding: 2px 6px; border-radius: 4px; color: white; margin-left: 5px; }
        .team-switch-btn.verde { background-color: #28a745; }
        .team-switch-btn.naranja { background-color: #ff9800; }
        
        /* Estilos para modal triangular */
        #triangular-winners-list { list-style: none; padding: 0; margin-top: 15px; text-align: left; max-height: 40vh; overflow-y: auto; }
        #triangular-winners-list li { padding: 8px; border-bottom: 1px solid #eee; }
        #triangular-winners-list li:last-child { border-bottom: none; }
        #triangular-winners-list label { display: flex; align-items: center; cursor: pointer; }
        #triangular-winners-list input[type="checkbox"] { margin-right: 10px; width: 18px; height: 18px; }


        /* Estilos para m√≥viles */
        @media screen and (max-width:600px){
            body{padding:5px}.container{padding:15px; padding-bottom: 80px;}h1{font-size:1.5em}.probabilidad{font-size:2em}.recomendacion{font-size:1em}
            table,thead,tbody,th,td,tr{display:block}
            thead tr{position:absolute;top:-9999px;left:-9999px}
            tr{border:1px solid #ccc;margin-bottom:15px;border-radius:5px;padding:5px}
            td{border:none;border-bottom:1px solid #eee;position:relative;padding-left:50%;text-align:right}
            td:before{position:absolute;left:6px;width:45%;padding-right:10px;white-space:nowrap;text-align:left;font-weight:700}
            td:nth-of-type(1):before{content:"Nombre"}td:nth-of-type(2):before{content:"Estado"}td:nth-of-type(3):before{content:"Equipo"}td:nth-of-type(4):before{content:"Bajas"}td:nth-of-type(5):before{content:"Fiabilidad"}td:nth-of-type(6):before{content:"Acci√≥n"}
            .status-radio{justify-content:flex-end}input[type=number]{width:70px}
            .admin-view .admin-only{display:block !important;}
        }
    </style>
</head>
<body>

<div class="container">
    <h1>
        <div class="login-controls"><div class="login-icon-wrapper" id="admin-lock-wrapper"><span id="admin-lock">üîì</span><span class="login-label">Admin</span></div></div>
        Gestor de Partido
        <div class="login-controls"><div class="login-icon-wrapper" id="player-login-wrapper"><span id="player-login">üë§</span><span class="login-label">Login</span></div></div>
    </h1>

    <div class="login-info-container">
        <div id="match-menu-icon">‚ò∞<span class="notification-dot"></span>
            <div id="match-menu-dropdown">
                <div class="menu-option" id="menu-option-equipos"><span class="notification-dot-text">üî¥</span>Equipos</div>
                <div class="menu-option" id="menu-option-finanzas">Finanzas</div>
            </div>
        </div>
        <div id="login-info" class="highlight-login">Identif√≠cate para responder ‚Üí</div>
    </div>
    
    <div class="date-header">
        <h2 id="match-date-title">Cargando...</h2>
    </div>

    <div id="main-content" style="display: none;">
        <div id="pending-activation" style="display: none;">
            <h3>Partido pendiente de activarse</h3>
            <p>Se avisar√° por WhatsApp en breve.</p>
        </div>
        
        <button id="archive-button" class="admin-only admin-button" style="display:none; background-color: #1a73e8;">Archivar y Activar Siguiente Partido</button>
        <button id="reset-button" class="admin-only admin-button" style="display:none;">Resetear Asistencia</button>
        <button id="toggle-refuerzos-button" class="admin-only admin-button" style="display:none;"></button>
        
        <div id="equipment-summary" style="display: none;"></div>
        <div id="resultado"></div>
        <div id="weather-forecast">Cargando previsi√≥n del tiempo...</div>
        
        <div id="google-maps-link" style="text-align: center; margin-top: 15px; margin-bottom: 15px;">
          <a href="https://maps.app.goo.gl/XNrNwAtzw4AuSpWx9" style="text-decoration: none; font-size: 1.2em; color: #1a73e8;"> üöó Ver ruta en Google Maps</a>
        </div>
        
        <div id="refuerzos-section" style="display:none;">
            <h4>A√±adir Refuerzos</h4>
            <input type="text" id="refuerzo-nombre" placeholder="Nombre del refuerzo..."><button id="add-refuerzo-btn">A√±adir</button>
        </div>
        
        <table id="tabla-jugadores">
            <thead><tr><th>Nombre</th><th>Estado</th><th class="admin-only">Equipo</th><th class="admin-only">Bajas</th><th>Fiabilidad</th><th class="admin-only">Acci√≥n</th></tr></thead>
            <tbody></tbody>
        </table>

        <div id="add-player-section" class="admin-only" style="display:none;">
            <h4>A√±adir Nuevo Jugador a la Plantilla</h4>
            <input type="text" id="new-player-name" placeholder="Nombre del nuevo jugador..."><button id="add-player-btn">A√±adir</button>
        </div>
        
        <div id="admin-test-section" style="display: none; margin-top: 20px; padding: 15px; border: 2px dashed #ccc; border-radius: 8px;">
            <h4 style="margin-top:0;">Modo Test</h4>
            <label for="test-date">Simular Fecha y Hora:</label>
            <input type="datetime-local" id="test-date"><button id="apply-test-date">Aplicar</button><button id="reset-test-date">Hora Real</button>
            <p id="current-time-display" style="font-size: 0.9em; color: #555; margin-top: 10px;"></p>
        </div>
    </div>
</div>

<a id="whatsapp-button" title="Abrir grupo de WhatsApp">
    <svg viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.61 15.31 3.4 16.78L2 22L7.33 20.62C8.75 21.35 10.35 21.79 12.04 21.79C17.5 21.79 21.95 17.34 21.95 11.88C21.95 6.42 17.5 2 12.04 2M12.04 3.64C16.56 3.64 20.21 7.29 20.21 11.81C20.21 16.33 16.56 19.98 12.04 19.98C10.53 19.98 9.11 19.59 7.89 18.91L7.44 18.66L3.93 19.58L4.87 16.16L4.59 15.69C3.83 14.38 3.39 12.89 3.39 11.31C3.39 6.79 7.04 3.14 11.56 3.14H12.04M8.88 7.33C8.71 6.84 8.54 6.84 8.38 6.84C8.22 6.84 8 6.84 7.79 6.84C7.58 6.84 7.31 6.91 7.09 7.16C6.87 7.41 6.22 8 6.22 9.24C6.22 10.48 7.11 11.65 7.26 11.84C7.41 12.03 8.81 14.34 11.1 15.31C13.39 16.28 13.83 16.08 14.24 16.03C14.65 15.98 15.53 15.48 15.74 14.89C15.95 14.3 15.95 13.81 15.89 13.7C15.83 13.59 15.67 13.53 15.41 13.41C15.15 13.29 14.09 12.76 13.88 12.68C13.67 12.6 13.53 12.57 13.39 12.81C13.25 13.05 12.81 13.59 12.67 13.73C12.53 13.87 12.39 13.89 12.18 13.78C11.97 13.67 11.04 13.34 9.91 12.35C9.01 11.58 8.41 10.64 8.27 10.4C8.13 10.16 8.24 10.04 8.35 9.93C8.45 9.82 8.58 9.66 8.7 9.53C8.82 9.4 8.87 9.29 8.95 9.11C9.03 8.93 8.98 8.78 8.92 8.66C8.86 8.54 8.46 7.53 8.27 7.33L8.88 7.33Z" /></svg>
</a>

<div id="custom-alert-modal" class="modal-overlay"><div class="modal-box"><h3 id="modal-title" class="modal-title"></h3><div id="modal-message" class="modal-message"></div><button id="modal-button" class="modal-button">Aceptar</button></div></div>
<div id="custom-confirm-modal" class="modal-overlay"><div class="modal-box"><h3 id="confirm-title" class="modal-title"></h3><p id="confirm-message" class="modal-message"></p><div class="modal-buttons"><button id="confirm-cancel" class="modal-button cancel">Cancelar</button><button id="confirm-ok" class="modal-button">Aceptar</button></div></div></div>
<div id="custom-prompt-modal" class="modal-overlay"><div class="modal-box"><h3 id="prompt-title" class="modal-title"></h3><input id="prompt-input" class="modal-input" type="password"><div class="modal-buttons"><button id="prompt-cancel" class="modal-button cancel">Cancelar</button><button id="prompt-ok" class="modal-button">Aceptar</button></div></div></div>
<div id="equipment-modal" class="modal-overlay"><div class="modal-box"><h3 class="modal-title">Material</h3><div class="equipment-question"><p>‚öΩ ¬øVas a llevar bal√≥n?</p><label><input type="radio" name="balon-radio" value="si"> S√≠</label><label><input type="radio" name="balon-radio" value="no" checked> No</label></div><div class="equipment-question"><p>üëï ¬øVas a llevar petos?</p><label><input type="radio" name="petos-radio" value="si"> S√≠</label><label><input type="radio" name="petos-radio" value="no" checked> No</label></div><div class="modal-buttons" style="margin-top: 20px;"><button id="equipment-cancel" class="modal-button cancel">Cancelar</button><button id="equipment-ok" class="modal-button">Aceptar</button></div></div></div>
<div id="teams-modal" class="modal-overlay"><div class="modal-box"><h3 class="modal-title">Equipos</h3><div id="teams-content" class="team-modal-container"></div><div class="modal-buttons" style="margin-top: 25px;"><button id="teams-ok" class="modal-button">Cerrar</button></div></div></div>
<div id="victory-modal" class="modal-overlay"><div class="modal-box"><h3 class="modal-title">¬øQu√© equipo ha ganado?</h3><div id="victory-teams-content" class="team-modal-container"></div><div class="modal-buttons" style="margin-top: 25px;"><button id="victory-cancel" class="modal-button cancel">Cancelar</button><button id="victory-verde" class="modal-button" style="background-color:#28a745;">Gana Verde</button><button id="victory-naranja" class="modal-button" style="background-color:#ff9800;">Gana Naranja</button></div></div></div>

<div id="match-type-modal" class="modal-overlay"><div class="modal-box"><h3 class="modal-title">Tipo de Partido</h3><p class="modal-message">¬øSe ha jugado un partido sencillo o un triangular?</p><div class="modal-buttons"><button id="match-type-sencillo" class="modal-button">Partido Sencillo</button><button id="match-type-triangular" class="modal-button">Triangular</button></div></div></div>
<div id="triangular-winner-modal" class="modal-overlay"><div class="modal-box"><h3 class="modal-title">Ganadores del Triangular</h3><p class="modal-message">Selecciona los jugadores que han ganado:</p><ul id="triangular-winners-list"></ul><div class="modal-buttons"><button id="triangular-cancel" class="modal-button cancel">Cancelar</button><button id="triangular-ok" class="modal-button">Aceptar</button></div></div></div>
<div id="whatsapp-warning-modal" class="modal-overlay"><div class="modal-box"><h3 class="modal-title">Aviso: Equipo Lleno</h3><p class="modal-message">Ya hay 12 jugadores en el equipo. Solo a√±ade al jugador si ya has avisado en el grupo de WhatsApp.</p><div class="modal-buttons"><button id="warning-cancel" class="modal-button cancel">Cancelar</button><button id="warning-whatsapp" class="modal-button" style="background-color:#25D366;">Abrir WhatsApp</button><button id="warning-add" class="modal-button">A√±adir Jugador</button></div></div></div>
<div id="date-picker-modal" class="modal-overlay"><div class="modal-box"><h3 class="modal-title">Pr√≥ximo Partido</h3><p class="modal-message">Selecciona la fecha del siguiente partido.</p><input type="date" id="next-match-date-input" class="modal-input" style="width: auto; font-size: 1.2em; padding: 10px;"><div class="modal-buttons"><button id="date-picker-cancel" class="modal-button cancel">Cancelar</button><button id="date-picker-ok" class="modal-button">Aceptar</button></div></div></div>


<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
// --- CONFIGURACI√ìN E INICIALIZACI√ìN DE FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyAeUfYINReyta5uNZd8sDCylju0nE7oy-A",
  authDomain: "entrenamientos-5f314.firebaseapp.com",
  databaseURL: "https://entrenamientos-5f314-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "entrenamientos-5f314",
  storageBucket: "entrenamientos-5f314.firebasestorage.app",
  messagingSenderId: "322454738753",
  appId: "G-SGS7EYBFTZ"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const serverTimestamp = firebase.database.ServerValue.TIMESTAMP;

// --- VARIABLES GLOBALES ---
const WHATSAPP_GROUP_LINK = 'https://chat.whatsapp.com/HkJ7ha85RvsHl4URkdwFcd?mode=ems_copy_t';
let adminPassword = "";
let isAdmin = false;
let loggedInPlayer = null;
let currentDbData = null;
let simulatedTime = null;
let isMatchPendingActivation = false;
let weatherHasBeenFetched = false;

// --- SISTEMA DE VENTANAS MODALES ---
function showCustomAlert(title, message, onOk) {
    const el = document.getElementById('custom-alert-modal');
    el.querySelector('#modal-title').textContent = title;
    el.querySelector('#modal-message').innerHTML = message.replace(/\n/g, '<br>');
    el.style.display = 'flex';
    el.querySelector('#modal-button').onclick = () => { el.style.display = 'none'; if (onOk) onOk(); };
}
function showCustomConfirm(title, message) {
    return new Promise(resolve => {
        const modal = document.getElementById('custom-confirm-modal');
        modal.querySelector('#confirm-title').textContent = title;
        modal.querySelector('#confirm-message').innerHTML = message.replace(/\n/g, '<br>');
        modal.style.display = 'flex';
        const okBtn = modal.querySelector('#confirm-ok');
        const cancelBtn = modal.querySelector('#confirm-cancel');
        const close = v => { modal.style.display = 'none'; okBtn.onclick = null; cancelBtn.onclick = null; resolve(v); };
        okBtn.onclick = () => close(true);
        cancelBtn.onclick = () => close(false);
    });
}
function showCustomPrompt(title) {
    return new Promise(resolve => {
        const modal = document.getElementById('custom-prompt-modal');
        const input = modal.querySelector('#prompt-input');
        modal.querySelector('#prompt-title').textContent = title;
        input.value = '';
        modal.style.display = 'flex';
        input.focus();
        const okBtn = modal.querySelector('#prompt-ok');
        const cancelBtn = modal.querySelector('#prompt-cancel');
        const close = v => { modal.style.display = 'none'; okBtn.onclick = null; cancelBtn.onclick = null; input.onkeydown = null; resolve(v); };
        okBtn.onclick = () => close(input.value);
        cancelBtn.onclick = () => close(null);
        input.onkeydown = e => { if (e.key === 'Enter') close(input.value); };
    });
}
function showEquipmentModal() {
    return new Promise(resolve => {
        const modal = document.getElementById('equipment-modal');
        modal.style.display = 'flex';
        modal.querySelector('input[name="balon-radio"][value="no"]').checked = true;
        modal.querySelector('input[name="petos-radio"][value="no"]').checked = true;
        const okBtn = modal.querySelector('#equipment-ok');
        const cancelBtn = modal.querySelector('#equipment-cancel');
        const close = (value) => {
            modal.style.display = 'none';
            okBtn.onclick = null; cancelBtn.onclick = null;
            resolve(value);
        };
        okBtn.onclick = () => {
            const balon = modal.querySelector('input[name="balon-radio"]:checked').value;
            const petos = modal.querySelector('input[name="petos-radio"]:checked').value;
            close({ balon, petos });
        };
        cancelBtn.onclick = () => close(null);
    });
}
function getTeamsHtml() {
    const jugadores = currentDbData.jugadores || {};
    const refuerzos = currentDbData.refuerzos || {};
    const equipoVerde = [], equipoNaranja = [];
    
    Object.values(jugadores).sort((a,b) => a.nombre.localeCompare(b.nombre)).forEach(j => {
        if (j.status === 'si' && j.equipo) {
            (j.equipo === 'verde' ? equipoVerde : equipoNaranja).push(j.nombre);
        }
    });

    Object.values(refuerzos).forEach(r => {
        if (r.equipo) {
            (r.equipo === 'verde' ? equipoVerde : equipoNaranja).push(`<i>${r.nombre} (Amigo de ${r.anadidoPor})</i>`);
        }
    });

    return `<div class="team-column team-verde"><h4>üü¢ Equipo Verde (${equipoVerde.length})</h4><ul>${equipoVerde.map(n => `<li>${n}</li>`).join('')}</ul></div><div class="team-column team-naranja"><h4>üü† Equipo Naranja (${equipoNaranja.length})</h4><ul>${equipoNaranja.map(n => `<li>${n}</li>`).join('')}</ul></div>`;
}
function showTeamsModal() {
    const modal = document.getElementById('teams-modal');
    modal.querySelector('#teams-content').innerHTML = getTeamsHtml();
    modal.style.display = 'flex';
    modal.querySelector('#teams-ok').onclick = () => modal.style.display = 'none';
}
function showVictoryModal() {
    return new Promise(resolve => {
        const modal = document.getElementById('victory-modal');
        modal.querySelector('#victory-teams-content').innerHTML = getTeamsHtml();
        modal.style.display = 'flex';
        const verdeBtn = modal.querySelector('#victory-verde');
        const naranjaBtn = modal.querySelector('#victory-naranja');
        const cancelBtn = modal.querySelector('#victory-cancel');
        const close = v => { modal.style.display = 'none'; verdeBtn.onclick = null; naranjaBtn.onclick = null; cancelBtn.onclick = null; resolve(v); };
        verdeBtn.onclick = () => close('verde');
        naranjaBtn.onclick = () => close('naranja');
        cancelBtn.onclick = () => close(null);
    });
}
function showMatchTypeModal() {
    return new Promise(resolve => {
        const modal = document.getElementById('match-type-modal');
        modal.style.display = 'flex';
        const sencilloBtn = modal.querySelector('#match-type-sencillo');
        const triangularBtn = modal.querySelector('#match-type-triangular');
        const close = v => { modal.style.display = 'none'; sencilloBtn.onclick = null; triangularBtn.onclick = null; resolve(v); };
        sencilloBtn.onclick = () => close('sencillo');
        triangularBtn.onclick = () => close('triangular');
    });
}
function showTriangularWinnerModal(players) {
    return new Promise(resolve => {
        const modal = document.getElementById('triangular-winner-modal');
        const list = modal.querySelector('#triangular-winners-list');
        list.innerHTML = players.map(p => `<li><label><input type="checkbox" data-key="${p.key}">${p.nombre}</label></li>`).join('');
        modal.style.display = 'flex';
        const okBtn = modal.querySelector('#triangular-ok');
        const cancelBtn = modal.querySelector('#triangular-cancel');
        const close = v => { modal.style.display = 'none'; okBtn.onclick = null; cancelBtn.onclick = null; resolve(v); };
        okBtn.onclick = () => {
            const winners = Array.from(list.querySelectorAll('input:checked')).map(input => input.dataset.key);
            close(winners); // <-- CAMBIO 1: Se llama a close() para cerrar el modal.
        };
        cancelBtn.onclick = () => close(null);
    });
}
function showWhatsappWarningModal() {
    return new Promise(resolve => {
        const modal = document.getElementById('whatsapp-warning-modal');
        modal.style.display = 'flex';
        const cancelBtn = modal.querySelector('#warning-cancel');
        const whatsappBtn = modal.querySelector('#warning-whatsapp');
        const addBtn = modal.querySelector('#warning-add');
        const close = v => { modal.style.display = 'none'; cancelBtn.onclick = null; whatsappBtn.onclick = null; addBtn.onclick = null; resolve(v); };
        cancelBtn.onclick = () => close('cancel');
        whatsappBtn.onclick = () => close('whatsapp');
        addBtn.onclick = () => close('add');
    });
}
// --- CAMBIO 2: Nueva funci√≥n para el modal de selecci√≥n de fecha ---
function showDatePickerModal() {
    return new Promise(resolve => {
        const modal = document.getElementById('date-picker-modal');
        const dateInput = modal.querySelector('#next-match-date-input');
        dateInput.value = ''; // Limpiar valor anterior
        modal.style.display = 'flex';

        const okBtn = modal.querySelector('#date-picker-ok');
        const cancelBtn = modal.querySelector('#date-picker-cancel');

        const close = (value) => {
            modal.style.display = 'none';
            okBtn.onclick = null;
            cancelBtn.onclick = null;
            resolve(value);
        };

        okBtn.onclick = () => {
            const selectedDate = dateInput.value;
            if (!selectedDate) {
                showCustomAlert('Error', 'Por favor, selecciona una fecha.');
                return;
            }
            // La fecha del input (YYYY-MM-DD) se interpreta como UTC, hay que ajustar para evitar problemas de zona horaria
            const dateObj = new Date(selectedDate + 'T12:00:00Z'); 
            if (dateObj.getUTCDay() !== 3) { // 3 = Mi√©rcoles (Domingo=0, Lunes=1...)
                showCustomAlert('Fecha no v√°lida', 'Solo es posible seleccionar como d√≠a de la semana mi√©rcoles.');
                return;
            }
            close(selectedDate);
        };
        cancelBtn.onclick = () => close(null);
    });
}

// --- L√ìGICA DE LOGIN ---
database.ref('config/password').once('value', (snapshot) => { adminPassword = snapshot.val(); });
document.getElementById('admin-lock-wrapper').addEventListener('click', async () => {
    document.getElementById('match-menu-dropdown').style.display = 'none';
    const loginInfoDiv = document.getElementById('login-info');
    if (isAdmin) {
        isAdmin = false; loggedInPlayer = null;
        loginInfoDiv.textContent = 'Identif√≠cate para responder ‚Üí';
        loginInfoDiv.className = 'highlight-login';
        renderUI();
    } else {
        const pass = await showCustomPrompt('Contrase√±a de Administrador');
        if (pass === adminPassword) {
            isAdmin = true; loggedInPlayer = null;
            loginInfoDiv.textContent = 'Sesi√≥n iniciada como Administrador';
            loginInfoDiv.className = '';
        } else if (pass !== null) { showCustomAlert('Error', 'Contrase√±a incorrecta.'); }
        renderUI();
    }
});
document.getElementById('player-login-wrapper').addEventListener('click', async () => {
    document.getElementById('match-menu-dropdown').style.display = 'none'; // <-- CAMBIO 3: Cierra el men√∫
    if (!currentDbData || !currentDbData.jugadores) return;
    const accessCode = await showCustomPrompt('C√≥digo de Acceso');
    if (!accessCode) return;
    const playerKey = Object.keys(currentDbData.jugadores).find(key => currentDbData.jugadores[key].password === accessCode);
    const loginInfoDiv = document.getElementById('login-info');
    if (playerKey) {
        loggedInPlayer = {...currentDbData.jugadores[playerKey], key: playerKey};
        isAdmin = false;
        loginInfoDiv.textContent = `Sesi√≥n iniciada como: ${loggedInPlayer.nombre}`;
        loginInfoDiv.className = '';
    } else { showCustomAlert('Error', 'C√≥digo de acceso no reconocido.'); }
    renderUI();
});

// --- L√ìGICA PRINCIPAL ---
document.addEventListener('DOMContentLoaded', function() {

    // --- FUNCIONES INTERNAS ---
    function getCurrentTime() { return simulatedTime ? new Date(simulatedTime) : new Date(); }
    
    function getNextWednesday(now, forceNextWeek = false) {
        const d = new Date(now);
        const today = d.getDay();
        let offset = (3 - today + 7) % 7;
        const newDate = new Date(d);
        newDate.setDate(d.getDate() + offset);
        if ((offset === 0 && d.getHours() >= 22) || forceNextWeek) {
            newDate.setDate(newDate.getDate() + 7);
        }
        newDate.setHours(21, 0, 0, 0);
        return newDate;
    }
    
    async function fetchAndDisplayWeather() {
        if (weatherHasBeenFetched) return;
        weatherHasBeenFetched = true;
        const weatherDiv = document.getElementById('weather-forecast');
        try {
            const matchDate = getNextWednesday(getCurrentTime());
            const dateString = `${matchDate.getFullYear()}-${(matchDate.getMonth() + 1).toString().padStart(2, '0')}-${matchDate.getDate().toString().padStart(2, '0')}`;
            const url = `https://api.open-meteo.com/v1/forecast?latitude=40.31&longitude=-3.73&hourly=temperature_2m,precipitation_probability&start_date=${dateString}&end_date=${dateString}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to fetch');
            const data = await response.json();
            weatherDiv.innerHTML = `<span>Previsi√≥n:</span><span class="weather-icon">üå°Ô∏è</span><span>${data.hourly.temperature_2m[21].toFixed(0)}¬∞C</span><span class="weather-icon">üíß</span><span>${data.hourly.precipitation_probability[21]}%</span>`;
        } catch (error) { weatherDiv.textContent = 'No se pudo cargar la previsi√≥n.'; }
    }

    function checkLateBailoutConditions(oldStatus, newStatus, player) {
        if (oldStatus !== 'si' || newStatus !== 'no' || player.lateBailoutThisMatch) return false;
        const { jugadores, matchInfo } = currentDbData;
        const refuerzos = currentDbData.refuerzos || {};
        const matchDate = new Date(matchInfo.nextMatchDate);
        const wednesdayCutoff = new Date(matchDate);
        wednesdayCutoff.setHours(14, 0, 0, 0);
        if (getCurrentTime() < wednesdayCutoff) return false;
        const totalConfirmados = Object.values(jugadores).filter(j => j.status === 'si').length + Object.keys(refuerzos).length;
        return totalConfirmados >= 10;
    }

    function showPlayerReliability(playerKey) {
        if (!currentDbData || !currentDbData.jugadores[playerKey]) return;
        const history = currentDbData.historial || {};
        const player = currentDbData.jugadores[playerKey];
        const playerName = player.nombre;
        const bajasCount = player.bajas || 0;
        const victoriasCount = player.victorias || 0;
        const last4Matches = Object.keys(history).sort().slice(-4);
        let attendedLast4 = 0;
        last4Matches.forEach(matchKey => {
            if (history[matchKey].jugadores?.[playerKey]?.status === 'si') {
                attendedLast4++;
            }
        });
        const reliabilityLast4 = last4Matches.length > 0 ? (attendedLast4 / last4Matches.length * 100).toFixed(0) : 0;
        const allMatches = Object.keys(history);
        let attendedAllTime = 0;
        let answeredAllTime = 0;
        allMatches.forEach(matchKey => {
            const playerStatus = history[matchKey].jugadores?.[playerKey]?.status;
            if (playerStatus === 'si') {
                attendedAllTime++;
                answeredAllTime++;
            } else if (playerStatus === 'no') {
                answeredAllTime++;
            }
        });
        
        const partidosJugados = attendedAllTime;
        const victoriasTexto = `Partidos Ganados: ${victoriasCount}`;

        const reliabilityAllTime = answeredAllTime > 0 ? (attendedAllTime / answeredAllTime * 100).toFixed(0) : 0;
        const message = `<strong>√öltimos 4 Partidos:</strong>\n` + `Asistencias: ${attendedLast4} de ${last4Matches.length}\n` + `Fiabilidad: ${reliabilityLast4}%\n\n` + `<strong>Temporada 25-26:</strong>\n` + `Asistencias: ${partidosJugados} de ${allMatches.length}\n` + `Fiabilidad (Global): ${reliabilityAllTime}%\n` + `Bajas de √∫ltima hora: ${bajasCount}\n` + `${victoriasTexto}`;
        
        showCustomAlert(`Estad√≠sticas de ${playerName}`, message);
    }
    
    function renderSummary() {
        const { jugadores, matchInfo, historial } = currentDbData;
        const refuerzos = currentDbData.refuerzos || {};
        const ahora = getCurrentTime();

        const ballBringers = [], bibsBringers = [];
        Object.values(jugadores).forEach(j => {
            if (j.status === 'si') {
                if (j.llevaBalon) ballBringers.push(j.nombre.split(' ')[0]);
                if (j.llevaPetos) bibsBringers.push(j.nombre.split(' ')[0]);
            }
        });
        let equipmentHtml = '';
        if (ballBringers.length > 0) equipmentHtml += `<span><b>Bal√≥n:</b> ${ballBringers.join(', ')}</span>`;
        if (bibsBringers.length > 0) equipmentHtml += `<span><b>Petos:</b> ${bibsBringers.join(', ')}</span>`;
        document.getElementById('equipment-summary').innerHTML = equipmentHtml;
        document.getElementById('equipment-summary').style.display = equipmentHtml ? 'block' : 'none';
        
        const matchDate = (matchInfo && matchInfo.nextMatchDate) ? new Date(matchInfo.nextMatchDate) : getNextWednesday(ahora);
        
        const dateTitleEl = document.getElementById('match-date-title');
        const dateString = matchDate.toLocaleDateString('es-ES', { weekday: 'long', month: 'long', day: 'numeric' });
        dateTitleEl.innerHTML = `Siguiente partido:<br>${dateString}¬†<span id="match-stats-icon" class="info-icon">i</span>`;
        dateTitleEl.style.color = '#28a745';

        const { si, pendiente, no } = Object.keys(jugadores).reduce((acc, key) => {
            const j = {...jugadores[key], key};
            const status = j.status || 'pendiente';
            acc[status] = acc[status] || [];
            acc[status].push(j);
            return acc;
        }, { si: [], pendiente: [], no: [] });

        const sortByName = (a, b) => a.nombre.localeCompare(b.nombre);
        si.sort(sortByName); pendiente.sort(sortByName); no.sort(sortByName);
        
        const totalConfirmados = si.length + Object.keys(refuerzos).length;
        const totalPendientes = pendiente.length;

        const dotIcon = document.querySelector('#match-menu-icon .notification-dot');
        const dotText = document.querySelector('#match-menu-dropdown .notification-dot-text');
        
        if (totalConfirmados >= 10 && !isMatchPendingActivation) {
            dotIcon.style.display = 'block';
            dotText.style.display = 'inline';
        } else {
            dotIcon.style.display = 'none';
            dotText.style.display = 'none';
        }
        
        let probabilidad, recomendacion, claseColor, overrideHtml = null;
        const maximoPosiblePlantilla = si.length + pendiente.length;

        let proyeccionPendientes = 0;
        if (pendiente.length > 0 && historial) {
            const last4MatchesKeys = Object.keys(historial).sort().slice(-4);
            pendiente.forEach(jugador => {
                let attended = 0;
                if(last4MatchesKeys.length > 0){
                    last4MatchesKeys.forEach(matchKey => {
                        if (historial[matchKey]?.jugadores?.[jugador.key]?.status === 'si') attended++;
                    });
                }
                const fiabilidadReal = last4MatchesKeys.length > 0 ? (attended / last4MatchesKeys.length) : 0;
                const fiabilidad = Math.max(fiabilidadReal, 0.1);

                const mondayStart = new Date(matchDate);
                mondayStart.setDate(mondayStart.getDate() - 2);
                mondayStart.setHours(0, 0, 0, 0);

                const tuesdayEnd = new Date(mondayStart);
                tuesdayEnd.setDate(tuesdayEnd.getDate() + 1);
                tuesdayEnd.setHours(14, 0, 0, 0);

                let factorTiempo = 1.0;
                if (ahora > mondayStart) {
                    if (ahora < tuesdayEnd) {
                        factorTiempo = 1.0 - ((ahora - mondayStart) / (tuesdayEnd - mondayStart) * (1.0 - 0.33));
                    } else {
                        factorTiempo = 0.33;
                    }
                }
                proyeccionPendientes += 9 * fiabilidad * factorTiempo; // <-- CAMBIO 4: Multiplicador cambiado a 9
            });
        }
        
        probabilidad = ((si.length + Object.keys(refuerzos).length) * 10) + proyeccionPendientes;

        if (totalConfirmados >= 10) {
            claseColor = "verde";
            overrideHtml = `<p class="probabilidad" style="font-size: 1.8em; line-height: 1.2;">Partido Confirmado</p>`;
            recomendacion = `Ya somos ${totalConfirmados}.`;
        } else if (maximoPosiblePlantilla < 10) {
            claseColor = "rojo";
            overrideHtml = `<p class="probabilidad" style="font-size: 1.5em; line-height: 1.2;">Partido en Riesgo</p>`;
            recomendacion = `Imposible llegar a 10. Se necesitan ${10 - totalConfirmados} refuerzo(s).`;
        } else {
            probabilidad = Math.min(probabilidad, 98);

            const decayStart = new Date(matchDate);
            decayStart.setDate(decayStart.getDate() - 1);
            decayStart.setHours(14, 0, 0, 0);
            
            let finalDecayActive = false;
            if (ahora > decayStart) {
                if (ahora < matchDate) {
                    probabilidad *= (1 - ((ahora - decayStart) / (matchDate - decayStart)));
                    finalDecayActive = true;
                } else {
                    probabilidad = 0;
                }
            }
            
            if (probabilidad >= 50) { claseColor = "ambar"; }
            else { claseColor = "rojo"; }

            if (finalDecayActive) {
                recomendacion = "¬°El tiempo se agota! Confirma ya.";
            } else {
                recomendacion = "Por favor, confirmar lo antes posible.";
            }
        }
        
        const monday14h = new Date(matchDate);
        monday14h.setDate(matchDate.getDate() - 2);
        monday14h.setHours(14, 0, 0, 0);
        
        const tuesday14h = new Date(matchDate);
        tuesday14h.setDate(tuesday14h.getDate() - 1);
        tuesday14h.setHours(14, 0, 0, 0);

        const wednesday14h = new Date(matchDate);
        wednesday14h.setHours(14, 0, 0, 0);

        let shouldAutoOpen = false;
        const lastMatch = Object.values(historial || {}).pop();

        if (lastMatch?.cancelado && ahora >= monday14h && totalConfirmados < 10) {
            shouldAutoOpen = true;
        }
        if (ahora >= wednesday14h && totalConfirmados < 12) {
            shouldAutoOpen = true;
        }
        
        if (ahora >= monday14h && ahora < tuesday14h && probabilidad < 50) {
            shouldAutoOpen = true;
        } else if (ahora >= tuesday14h && probabilidad < 70) {
            shouldAutoOpen = true;
        }
        
        if (shouldAutoOpen && !matchInfo?.refuerzosAbiertos) {
            database.ref('matchInfo/refuerzosAbiertos').set(true);
        }
        
        const isRefuerzosOpen = matchInfo?.refuerzosAbiertos || shouldAutoOpen;
        const refuerzosVisible = (isAdmin || (loggedInPlayer && isRefuerzosOpen)) && !isMatchPendingActivation;
        document.getElementById('refuerzos-section').style.display = refuerzosVisible ? 'block' : 'none';
        
        const siHtml = si.map(j => `<li><span class="status-icon icon-si">‚úî</span><span class="summary-player-name" data-key="${j.key}">${j.nombre}</span></li>`).join('');
        
        const refuerzosHtml = Object.entries(refuerzos).map(([key, ref]) => {
            const showDeleteIcon = isAdmin || (loggedInPlayer && loggedInPlayer.nombre === ref.anadidoPor);
            const deleteIconHtml = showDeleteIcon ? `<span class="delete-refuerzo" data-key="${key}" data-owner="${ref.anadidoPor}">‚ùå</span>` : '';
            return `<li><span class="status-icon icon-si">‚úî</span><i>${ref.nombre} (Amigo de ${ref.anadidoPor})</i>${deleteIconHtml}</li>`;
        }).join('');
        
        const pendienteHtml = pendiente.map(j => `<li><span class="status-icon icon-pendiente">?</span><span class="summary-player-name" data-key="${j.key}">${j.nombre}</span></li>`).join('');
        const noHtml = no.map(j => `<li><span class="status-icon icon-no">‚úñ</span><span class="summary-player-name" data-key="${j.key}">${j.nombre}</span></li>`).join('');
        
        const listaHtml = `<div class="resumen"><strong>Respuestas (${totalConfirmados} confirmados, ${totalPendientes} pendientes):</strong><ul class="lista-apuntados">${siHtml}${refuerzosHtml}${pendienteHtml}${noHtml}</ul></div>`;
        
        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.className = 'resultado ' + claseColor;

        let refuerzosOpenHtml = '';
        if (isRefuerzosOpen && totalConfirmados < 10) {
            refuerzosOpenHtml = `<p class="recomendacion" style="margin-top: 5px; font-size: 0.9em;">Activada opci√≥n de a√±adir amigos</p>`;
        }

        if (overrideHtml) {
            resultadoDiv.innerHTML = overrideHtml + `<p class="recomendacion">${recomendacion}</p>` + refuerzosOpenHtml + listaHtml;
        } else {
            // <-- CAMBIO 5: Reordenaci√≥n del texto y el porcentaje.
            const mainHtml = `<div style="display: flex; align-items: baseline; justify-content: center; gap: 8px;">
                               <p style="margin: 0; font-size: 1.1em; font-weight: 400;">Probabilidad de jugar:</p>
                               <p class="probabilidad" style="margin: 0;">${probabilidad.toFixed(0)}% <span id="probabilidad-info-icon" class="info-icon">i</span></p>
                            </div>`;
            resultadoDiv.innerHTML = mainHtml + `<p class="recomendacion">${recomendacion}</p>` + refuerzosOpenHtml + listaHtml;
        }
    }

    function renderTable() {
        const tablaBody = document.querySelector("#tabla-jugadores tbody");
        tablaBody.innerHTML = '';
        const { jugadores, historial } = currentDbData;
        const last4 = Object.keys(historial || {}).sort().slice(-4);
        const totalConfirmados = Object.values(jugadores).filter(p => p.status === 'si').length + Object.keys(currentDbData.refuerzos || {}).length;

        Object.keys(jugadores || {}).sort((a,b) => jugadores[a].nombre.localeCompare(jugadores[b].nombre)).forEach(key => {
            const j = jugadores[key];
            const attended = last4.filter(k => historial[k]?.jugadores?.[key]?.status === 'si').length;
            const fiabilidad = last4.length > 0 ? `${(attended / last4.length * 100).toFixed(0)}%` : 'N/A';
            const status = j.status || 'pendiente';
            
            let equipoHtml = '-';
            if(isAdmin && j.status === 'si' && j.equipo && totalConfirmados >= 10) {
                 equipoHtml = `<span class="team-switch-btn ${j.equipo}" data-key="${key}">${j.equipo.charAt(0).toUpperCase()}</span>`;
            } else if (j.equipo) {
                 equipoHtml = j.equipo.charAt(0).toUpperCase();
            }

            tablaBody.innerHTML += `<tr data-key="${key}"><td>${j.nombre}</td><td><div class="status-radio"><label><input type="radio" name="status-${key}" value="si" ${status==='si'?'checked':''}> S√≠</label><label><input type="radio" name="status-${key}" value="no" ${status==='no'?'checked':''}> No</label><label><input type="radio" name="status-${key}" value="pendiente" ${status==='pendiente'?'checked':''}> Pendiente</label></div></td><td class="admin-only">${equipoHtml}</td><td class="admin-only"><input type="number" class="bajas" value="${j.bajas||0}" min="0"></td><td class="fiabilidad">${fiabilidad}</td><td class="admin-only"><button class="delete-player-btn" title="Eliminar">üóëÔ∏è</button></td></tr>`;
        });
    }

    function applyVisibility() {
        document.body.classList.toggle('admin-view', isAdmin);
        const isLoggedIn = isAdmin || loggedInPlayer;
        document.getElementById('whatsapp-button').style.display = isLoggedIn ? 'flex' : 'none';
        document.getElementById('tabla-jugadores').style.display = (isLoggedIn && !isMatchPendingActivation) || isAdmin ? '' : 'none';
        document.getElementById('admin-test-section').style.display = isAdmin ? 'block' : 'none';
        document.getElementById('match-menu-icon').style.display = isLoggedIn ? 'inline-block' : 'none';

        if(isMatchPendingActivation && !isAdmin){
            document.getElementById('equipment-summary').style.display = 'none';
            document.getElementById('weather-forecast').style.display = 'none';
            document.getElementById('google-maps-link').style.display = 'none';
            document.getElementById('refuerzos-section').style.display = 'none';
        } else if (!isMatchPendingActivation) {
            document.getElementById('weather-forecast').style.display = 'flex';
            document.getElementById('google-maps-link').style.display = 'block';
        }

        if (isAdmin) {
            const timeDisplay = document.getElementById('current-time-display');
            timeDisplay.textContent = `Hora sistema: ${getCurrentTime().toLocaleString('es-ES')} ${simulatedTime?'(SIMULADA)':''}`;
            document.getElementById('archive-button').style.display = isMatchPendingActivation ? 'block' : 'none';
            document.getElementById('reset-button').style.display = !isMatchPendingActivation ? 'block' : 'none';
            const toggleBtn = document.getElementById('toggle-refuerzos-button');
            const isOpen = currentDbData.matchInfo?.refuerzosAbiertos;
            toggleBtn.textContent = isOpen ? 'Desactivar A√±adir Amigos (Manual)' : 'Activar A√±adir Amigos (Manual)';
            toggleBtn.style.backgroundColor = isOpen ? '#dc3545' : '#28a745';
        } else {
             document.getElementById('archive-button').style.display = 'none';
             document.getElementById('reset-button').style.display = 'none';
             document.getElementById('toggle-refuerzos-button').style.display = 'none';
        }

        document.querySelectorAll('#tabla-jugadores tbody tr').forEach(fila => {
            const isPlayerRow = loggedInPlayer && loggedInPlayer.key === fila.dataset.key;
            if (loggedInPlayer && !isAdmin) {
                fila.style.display = isPlayerRow ? '' : 'none';
            } else {
                fila.style.display = '';
            }
            fila.querySelectorAll('input, button').forEach(el => {
                const isAdminOnlyControl = el.classList.contains('bajas') || el.classList.contains('delete-player-btn');
                if (isAdmin) {
                    el.disabled = false;
                } else if(isPlayerRow) {
                    el.disabled = isAdminOnlyControl;
                } else {
                    el.disabled = true;
                }
            });
        });
    }

    function renderUI() {
        if (!currentDbData) return;
        document.getElementById('main-content').style.display = 'block';

        const ahora = getCurrentTime();
        const nextMatchDate = (currentDbData.matchInfo && currentDbData.matchInfo.nextMatchDate) ? new Date(currentDbData.matchInfo.nextMatchDate) : getNextWednesday(ahora);
        
        isMatchPendingActivation = ahora > nextMatchDate;
        
        if (isMatchPendingActivation) {
            document.getElementById('pending-activation').style.display = isAdmin ? 'none' : 'block';
            document.getElementById('resultado').style.display = 'none';
        } else {
            document.getElementById('pending-activation').style.display = 'none';
            document.getElementById('resultado').style.display = 'block';
            renderSummary();
            renderTable();
        }
        applyVisibility();
    }
    
    function updateTaskerData(newData, oldData) {
        if (!newData) return;

        const { jugadores, refuerzos } = newData;
        const oldTaskerData = oldData?.Tasker;
        const updates = {};

        const si = Object.values(jugadores || {}).filter(j => j.status === 'si');
        const pendiente = Object.values(jugadores || {}).filter(j => j.status === 'pendiente' || !j.status);
        const newTotalConfirmados = si.length + Object.keys(refuerzos || {}).length;
        const newTotalPendientes = pendiente.length;
        const newPartidoCompleto = newTotalConfirmados >= 10;

        const equipoVerdeNombres = [];
        const equipoNaranjaNombres = [];

        Object.values(jugadores || {}).forEach(j => {
            if (j.status === 'si' && j.equipo) {
                if (j.equipo === 'verde') equipoVerdeNombres.push(j.nombre);
                else if (j.equipo === 'naranja') equipoNaranjaNombres.push(j.nombre);
            }
        });
        Object.values(refuerzos || {}).forEach(r => {
            if (r.equipo) {
                const nombreCompleto = `${r.nombre} (Amigo de ${r.anadidoPor})`;
                if (r.equipo === 'verde') equipoVerdeNombres.push(nombreCompleto);
                else if (r.equipo === 'naranja') equipoNaranjaNombres.push(nombreCompleto);
            }
        });
        
        equipoVerdeNombres.sort();
        equipoNaranjaNombres.sort();

        const newEquipoVerdeStr = equipoVerdeNombres.join(', ');
        const newEquipoNaranjaStr = equipoNaranjaNombres.join(', ');

        if ((oldTaskerData?.confirmados ?? -1) !== newTotalConfirmados) updates['/Tasker/confirmados'] = newTotalConfirmados;
        if ((oldTaskerData?.pendientes ?? -1) !== newTotalPendientes) updates['/Tasker/pendientes'] = newTotalPendientes;
        if ((oldTaskerData?.partidoCompleto ?? null) !== newPartidoCompleto) updates['/Tasker/partidoCompleto'] = newPartidoCompleto;
        if ((oldTaskerData?.equipoVerde ?? null) !== newEquipoVerdeStr) updates['/Tasker/equipoVerde'] = newEquipoVerdeStr;
        if ((oldTaskerData?.equipoNaranja ?? null) !== newEquipoNaranjaStr) updates['/Tasker/equipoNaranja'] = newEquipoNaranjaStr;
        
        if (Object.keys(updates).length > 0) {
            database.ref().update(updates);
        }
    }

    function generateBalancedTeams(jugadores, refuerzos, historial) {
        const updates = {};
        const totalPartidosHistorial = Object.keys(historial || {}).length;
        let playersWithPower = [];

        Object.entries(jugadores).forEach(([key, player]) => {
            if (player.status === 'si') {
                const victorias = player.victorias || 0;
                const partidosJugados = Object.values(historial || {}).filter(h => h.jugadores?.[key]?.status === 'si').length;
                const porcentajeVictorias = partidosJugados > 0 ? (victorias / partidosJugados) : 0;
                const porcentajeJugados = totalPartidosHistorial > 0 ? (partidosJugados / totalPartidosHistorial) : 0;
                const factor = 1 + porcentajeJugados;
                const power = (porcentajeVictorias * 100) * factor;
                playersWithPower.push({ key, power, type: 'jugador' });
            }
        });

        Object.keys(refuerzos).forEach(key => {
            playersWithPower.push({ key, power: 50, type: 'refuerzo' });
        });

        playersWithPower.sort((a, b) => b.power - a.power);

        let equipoVerde = { power: 0, players: [] };
        let equipoNaranja = { power: 0, players: [] };

        playersWithPower.forEach(player => {
            if (equipoVerde.players.length < equipoNaranja.players.length) {
                equipoVerde.players.push(player);
                equipoVerde.power += player.power;
            } else if (equipoNaranja.players.length < equipoVerde.players.length) {
                equipoNaranja.players.push(player);
                equipoNaranja.power += player.power;
            } else {
                if (equipoVerde.power <= equipoNaranja.power) {
                    equipoVerde.players.push(player);
                    equipoVerde.power += player.power;
                } else {
                    equipoNaranja.players.push(player);
                    equipoNaranja.power += player.power;
                }
            }
        });

        equipoVerde.players.forEach(p => {
            const path = p.type === 'jugador' ? `/jugadores/${p.key}/equipo` : `/refuerzos/${p.key}/equipo`;
            updates[path] = 'verde';
        });
        equipoNaranja.players.forEach(p => {
            const path = p.type === 'jugador' ? `/jugadores/${p.key}/equipo` : `/refuerzos/${p.key}/equipo`;
            updates[path] = 'naranja';
        });
        
        return updates;
    }


    // --- LISTENERS ---
    database.ref().on('value', (snapshot) => {
        const newData = snapshot.val();
        if (newData && newData.jugadores) {
            
            updateTaskerData(newData, currentDbData);
            
            if (newData.matchInfo?.nextMatchDate) {
                 const ahora = getCurrentTime();
                 const falseCutoff = new Date(newData.matchInfo.nextMatchDate);
                 falseCutoff.setHours(22, 0, 0, 0);

                 if (ahora > falseCutoff && newData.Tasker?.['partido iniciado'] !== false) {
                     database.ref('/Tasker/partido iniciado').set(false);
                 }
            }
            
            currentDbData = newData; 
            renderUI();
            if(!weatherHasBeenFetched) fetchAndDisplayWeather();
        }
    });

    document.getElementById('tabla-jugadores').addEventListener('change', async (e) => {
        const fila = e.target.closest('tr');
        if (!fila) return;
        const playerKey = fila.dataset.key;
        if (e.target.classList.contains('bajas')) {
            return database.ref(`jugadores/${playerKey}/bajas`).set(parseInt(e.target.value, 10));
        }
        if (e.target.name.startsWith('status-')) {
            const newStatus = e.target.value;
            const player = currentDbData.jugadores[playerKey];
            const oldStatus = player.status;
            let updates = {};
            const { jugadores, historial, refuerzos } = currentDbData;
            const totalSiAntes = Object.values(jugadores).filter(j => j.status === 'si').length + Object.keys(refuerzos || {}).length;

            if (checkLateBailoutConditions(oldStatus, newStatus, player)) {
                const confirmMessage = '¬øSeguro? Afectar√°s al partido.\n\nEs necesario avisar por WhatsApp del cambio.';
                if (await showCustomConfirm('Confirmaci√≥n', confirmMessage)) {
                    updates[`/jugadores/${playerKey}/bajas`] = (player.bajas || 0) + 1;
                    updates[`/jugadores/${playerKey}/lateBailoutThisMatch`] = true;
                    window.open(WHATSAPP_GROUP_LINK, '_blank');
                } else { return fila.querySelector(`input[value="si"]`).checked = true; }
            }
            
            if (newStatus === 'si' && oldStatus !== 'si') {
                const totalSiDespues = totalSiAntes + 1;
                const equipment = await showEquipmentModal();
                if (!equipment) return fila.querySelector(`input[value="${oldStatus}"]`).checked = true;
                updates[`/jugadores/${playerKey}/llevaBalon`] = equipment.balon === 'si' ? true : null;
                updates[`/jugadores/${playerKey}/llevaPetos`] = equipment.petos === 'si' ? true : null;

                const tempJugadores = JSON.parse(JSON.stringify(jugadores));
                if(tempJugadores[playerKey]) tempJugadores[playerKey].status = 'si';

                if (totalSiDespues === 10) {
                    const teamUpdates = generateBalancedTeams(tempJugadores, refuerzos || {}, historial || {});
                    Object.assign(updates, teamUpdates);
                } else if (totalSiDespues > 10) {
                    const equipos = { verde: [], naranja: [] };
                    Object.entries(jugadores).forEach(([key, j]) => {
                        if (j.status === 'si' && j.equipo && key !== playerKey) equipos[j.equipo].push(key);
                    });
                    Object.values(refuerzos || {}).forEach(r => { if(r.equipo) equipos[r.equipo].push(r.key); });
                    
                    updates[`/jugadores/${playerKey}/equipo`] = equipos.verde.length <= equipos.naranja.length ? 'verde' : 'naranja';
                }
            }
            
            if (oldStatus === 'si' && newStatus !== 'si') {
                updates[`/jugadores/${playerKey}/llevaBalon`] = null;
                updates[`/jugadores/${playerKey}/llevaPetos`] = null;
                updates[`/jugadores/${playerKey}/equipo`] = null;
            }

            updates[`/jugadores/${playerKey}/status`] = newStatus;
            updates[`/jugadores/${playerKey}/confirmTimestamp`] = newStatus === 'si' ? serverTimestamp : null;
            database.ref().update(updates);
        }
    });
    
    document.getElementById('add-refuerzo-btn').addEventListener('click', async () => {
        const nombreInput = document.getElementById('refuerzo-nombre');
        const nombre = nombreInput.value.trim();
        if(!nombre) return;
        if(!isAdmin && !loggedInPlayer) {
            return showCustomAlert('Aviso', "Debes identificarte para a√±adir un refuerzo.");
        }
        
        const { jugadores, refuerzos, historial } = currentDbData;
        const totalConfirmados = Object.values(jugadores).filter(j => j.status === 'si').length + Object.keys(refuerzos || {}).length;

        if (totalConfirmados >= 12) {
            const action = await showWhatsappWarningModal();
            if (action === 'whatsapp') {
                window.open(WHATSAPP_GROUP_LINK, '_blank');
                return; 
            } else if (action === 'cancel') {
                return;
            }
        }
       
        const anadidoPor = isAdmin ? 'Admin' : loggedInPlayer.nombre;
        const newRefuerzoRef = database.ref('refuerzos').push();
        const newRefuerzoKey = newRefuerzoRef.key; // Guarda la key
        const newRefuerzoData = { nombre, anadidoPor, key: newRefuerzoKey, timestamp: serverTimestamp };
        
        // 1. PRIMER UPDATE: Solo a√±ade el refuerzo b√°sico
        await newRefuerzoRef.set(newRefuerzoData); 

        // Prepara para el segundo update (si es necesario)
        const updatesEquipo = {};
        const tempRefuerzos = { ...(refuerzos || {}), [newRefuerzoKey]: newRefuerzoData };
        const newTotalConfirmados = totalConfirmados + 1;

        if (newTotalConfirmados === 10) {
            // Genera los updates para TODOS los equipos, incluyendo el nuevo refuerzo
            Object.assign(updatesEquipo, generateBalancedTeams(jugadores, tempRefuerzos, historial || {}));
        } else if (newTotalConfirmados > 10) {
            // Calcula solo el equipo para el NUEVO refuerzo
            const equipos = { verde: [], naranja: [] };
            Object.values(jugadores).forEach(j => { if (j.status === 'si' && j.equipo) equipos[j.equipo].push(j.key); });
            Object.values(refuerzos || {}).forEach(r => { if(r.equipo) equipos[r.equipo].push(r.key); });
            updatesEquipo[`/refuerzos/${newRefuerzoKey}/equipo`] = equipos.verde.length <= equipos.naranja.length ? 'verde' : 'naranja';
        }
        
        // 2. SEGUNDO UPDATE (si hay algo que actualizar en los equipos)
        if (Object.keys(updatesEquipo).length > 0) {
            await database.ref().update(updatesEquipo);
        }
        
        nombreInput.value = ''; // Limpiar input al final
    });

    document.getElementById('match-menu-icon').addEventListener('click', (e) => {
        e.stopPropagation();
        const dropdown = document.getElementById('match-menu-dropdown');
        const isVisible = dropdown.style.display === 'block';
        dropdown.style.display = isVisible ? 'none' : 'block';
        if (!isVisible) {
            const closeListener = (event) => {
                if (!dropdown.contains(event.target) && !e.currentTarget.contains(event.target)) {
                    dropdown.style.display = 'none';
                    window.removeEventListener('click', closeListener);
                }
            };
            window.addEventListener('click', closeListener, { once: true });
        }
    });
    
    document.getElementById('menu-option-equipos').addEventListener('click', async (e) => {
        e.stopPropagation();
        document.getElementById('match-menu-dropdown').style.display = 'none';
        
        if(isMatchPendingActivation) {
            return showCustomAlert('Aviso', 'Partido pendiente de activarse.');
        }

        const totalConfirmados = Object.values(currentDbData.jugadores).filter(j => j.status === 'si').length + Object.keys(currentDbData.refuerzos || {}).length;
        if (totalConfirmados < 10) {
            showCustomAlert('Aviso', 'No hay suficientes jugadores para formar equipos.');
        } else {
            showTeamsModal();
        }
    });
    
    document.getElementById('menu-option-finanzas').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('match-menu-dropdown').style.display = 'none';
        showCustomAlert('Finanzas', 'No disponible.');
    });

    document.getElementById('apply-test-date').addEventListener('click', () => { simulatedTime = document.getElementById('test-date').value ? new Date(document.getElementById('test-date').value) : null; renderUI(); });
    document.getElementById('reset-test-date').addEventListener('click', () => { simulatedTime = null; document.getElementById('test-date').value = ''; renderUI(); });
    
    document.getElementById('archive-button').addEventListener('click', async () => {
        if (!isAdmin || !isMatchPendingActivation) return;
        
        const matchType = await showMatchTypeModal();
        if (!matchType) return;

        const { jugadores, refuerzos, matchInfo } = currentDbData;
        const siPlantilla = Object.entries(jugadores).filter(([k,j]) => j.status === 'si').map(([k,j]) => ({...j, key:k}));
        const totalConfirmados = siPlantilla.length + Object.keys(refuerzos || {}).length;
        const updates = {};
        let historialData = { 
            jugadores: Object.fromEntries(Object.entries(jugadores).map(([k,v])=>[k,{nombre:v.nombre,status:v.status==='pendiente'?'no':v.status}])), 
            refuerzos:refuerzos||null, 
            cancelado:totalConfirmados<10, 
            con_extras:totalConfirmados>=10 && siPlantilla.length<10,
        };

        if (matchType === 'sencillo') {
            const winner = await showVictoryModal();
            if (!winner) return;
            historialData.ganador = winner;
            historialData.tipo = 'sencillo';
            Object.keys(jugadores).forEach(k => {
                const player = jugadores[k];
                if(player.status === 'si' && player.equipo === winner){
                    updates[`/jugadores/${k}/victorias`] = (player.victorias || 0) + 1;
                }
            });
        } else { // Triangular
            const winners = await showTriangularWinnerModal(siPlantilla);
            if (!winners) return;
            historialData.ganadores = winners;
            historialData.tipo = 'triangular';
            winners.forEach(playerKey => {
                updates[`/jugadores/${playerKey}/victorias`] = (jugadores[playerKey].victorias || 0) + 1;
            });
        }
        
        // <-- CAMBIO 2: L√≥gica de selecci√≥n de fecha
        const selectedDate = await showDatePickerModal();
        if (!selectedDate) return; // Si el usuario cancela, no se archiva.

        const ahora = getCurrentTime();
        const oldDate = new Date(matchInfo.nextMatchDate);
        const pad = n => n.toString().padStart(2,'0');
        const key = `${oldDate.getFullYear()}-${pad(oldDate.getMonth()+1)}-${pad(oldDate.getDate())}-${pad(oldDate.getHours())}${pad(oldDate.getMinutes())}${pad(oldDate.getSeconds())}`;
        
        Object.keys(jugadores).forEach(k => {
            updates[`/jugadores/${k}/status`] = 'pendiente';
            updates[`/jugadores/${k}/lateBailoutThisMatch`] = null;
            updates[`/jugadores/${k}/llevaBalon`] = null;
            updates[`/jugadores/${k}/llevaPetos`] = null;
            updates[`/jugadores/${k}/equipo`] = null;
            updates[`/jugadores/${k}/confirmTimestamp`] = null;
        });
        
        updates[`/historial/${key}`] = historialData;
        updates['/refuerzos'] = null;
        
        // <-- CAMBIO 2: Construir la nueva fecha con la hora fija
        const nextMatchDate = new Date(selectedDate);
        nextMatchDate.setHours(21, 0, 0, 0);
        updates['/matchInfo/nextMatchDate'] = nextMatchDate.toISOString();
        
        updates['/matchInfo/refuerzosAbiertos'] = null;
        updates['/matchInfo/manualTeamOverride'] = null;
        
        updates['/Tasker/partido iniciado'] = true;
        
        await database.ref().update(updates);
        showCustomAlert('√âxito', 'Partido archivado y nuevo partido activado.');
    });

    document.getElementById('reset-button').addEventListener('click', async () => {
        if (!isAdmin || !(await showCustomConfirm('Confirmar Acci√≥n', '¬øResetear asistencia?'))) return;
        const updates = {};
        Object.keys(currentDbData.jugadores).forEach(k => { 
            updates[`/jugadores/${k}/status`] = 'pendiente';
            updates[`/jugadores/${k}/llevaBalon`] = null;
            updates[`/jugadores/${k}/llevaPetos`] = null;
            updates[`/jugadores/${k}/equipo`] = null;
            updates[`/jugadores/${k}/confirmTimestamp`] = null;
        });
        updates['/refuerzos'] = null;
        updates['/matchInfo/manualTeamOverride'] = null;
        database.ref().update(updates);
    });
    document.getElementById('toggle-refuerzos-button').addEventListener('click', () => { if(isAdmin) database.ref('matchInfo/refuerzosAbiertos').set(!currentDbData.matchInfo?.refuerzosAbiertos); });
    document.getElementById('add-player-btn').addEventListener('click', async () => {
        const newName = document.getElementById('new-player-name').value.trim();
        if (!newName) return;
        const newPass = await showCustomPrompt(`Contrase√±a para ${newName}`);
        if (!newPass) return;
        database.ref('jugadores').push({ nombre: newName, password: newPass, status: "pendiente", bajas: 0, victorias: 0 });
        document.getElementById('new-player-name').value = '';
    });

    document.body.addEventListener('click', async e => {
        if (e.target.closest('.delete-refuerzo')) {
            const el = e.target.closest('.delete-refuerzo');
            if(isAdmin || (loggedInPlayer && loggedInPlayer.nombre === el.dataset.owner)) {
                if (await showCustomConfirm('Confirmar', '¬øEliminar a este refuerzo?')) {
                    database.ref('refuerzos/' + el.dataset.key).remove();
                }
            }
        } else if (e.target.closest('#whatsapp-button')) { 
            window.open(WHATSAPP_GROUP_LINK, '_blank'); 
        } else if (e.target.closest('.summary-player-name')) {
            const el = e.target.closest('.summary-player-name');
            showPlayerReliability(el.dataset.key);
        } else if (e.target.closest('.delete-player-btn')) {
            const playerKey = e.target.closest('tr').dataset.key;
            if(await showCustomConfirm('Eliminar Jugador', '¬øSeguro? Esta acci√≥n es permanente.')) {
                database.ref('jugadores/' + playerKey).remove();
            }
        } else if (e.target.closest('.team-switch-btn')) {
            if(!isAdmin) return;
            const el = e.target.closest('.team-switch-btn');
            const playerKey = el.dataset.key;
            const currentTeam = currentDbData.jugadores[playerKey].equipo;
            const newTeam = currentTeam === 'verde' ? 'naranja' : 'verde';
            const updates = {};
            updates[`/jugadores/${playerKey}/equipo`] = newTeam;
            updates['/matchInfo/manualTeamOverride'] = true;
            await database.ref().update(updates);
            showCustomAlert('Cambio Manual', `Equipos desbalanceados manualmente.\nEl balanceo autom√°tico por victorias queda desactivado para este partido.`);
        }
        else if (e.target.id === 'probabilidad-info-icon') {
            const message = 'Esta probabilidad se calcula sumando:\n\n' +
                          '‚Ä¢ 10% por cada jugador confirmado (plantilla o amigo).\n' +
                          '‚Ä¢ Un % adicional por cada jugador pendiente, basado en su fiabilidad de asistencia en los √∫ltimos 4 partidos.\n' +
                          '‚Ä¢ Seg√∫n se acerca la hora del partido la probabilidad se ve reducida.\n\n' +
                          'Para ver las estad√≠sticas detalladas de un jugador, pulsa sobre su nombre en la lista.';
            showCustomAlert('C√°lculo de Probabilidad', message);
        }
        else if (e.target.id === 'match-stats-icon') {
            const historial = currentDbData.historial || {};
            const partidosTotales = Object.keys(historial).length;
            const partidosCancelados = Object.values(historial).filter(p => p.cancelado).length;
            const partidosConExtras = Object.values(historial).filter(p => p.con_extras).length;
            const partidosJugados = partidosTotales - partidosCancelados;

            const message = `<strong>Partidos totales:</strong> ${partidosTotales}\n` +
                          `<strong>Partidos jugados:</strong> ${partidosJugados}\n` +
                          `<strong>Partidos cancelados:</strong> ${partidosCancelados}\n` +
                          `<strong>Partidos jugados gracias a amigos:</strong> ${partidosConExtras}`;

            showCustomAlert('Partidos Temporada 25-26', message);
        }
    });
    
    window.renderUI = renderUI;
});
</script>
</body>
</html>
